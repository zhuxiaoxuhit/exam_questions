"""
è€ƒé¢˜ç”Ÿæˆç³»ç»Ÿ
ä»è¾“å…¥çš„xlsxæ–‡ä»¶ä¸­è¯»å–é‰´å®šç‚¹ä¿¡æ¯,ä½¿ç”¨LLMç”Ÿæˆè€ƒé¢˜,è¾“å‡ºç¬¦åˆæ ¼å¼è¦æ±‚çš„xlsxæ–‡ä»¶
"""

import os
import sys
import io
import re
import json
import logging
from datetime import datetime
from typing import Dict, List, Tuple, Optional
import openpyxl
from openpyxl import Workbook
import xlwt
from docx import Document
from docx.shared import Pt, RGBColor
from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
from openai import OpenAI
from dotenv import load_dotenv

# Windowsä¸‹è®¾ç½®UTF-8ç¼–ç 
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()


def setup_logging(log_dir: str = "logs") -> str:
    """
    é…ç½®æ—¥å¿—ç³»ç»Ÿï¼ŒåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ–‡ä»¶

    Args:
        log_dir: æ—¥å¿—æ–‡ä»¶ç›®å½•

    Returns:
        æ—¥å¿—æ–‡ä»¶è·¯å¾„
    """
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    if not os.path.exists(log_dir):
        os.makedirs(log_dir)

    # ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    log_filename = f"question_generation_{timestamp}.log"
    log_filepath = os.path.join(log_dir, log_filename)

    # åˆ›å»ºlogger
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    # æ¸…é™¤å·²æœ‰çš„handlers
    logger.handlers.clear()

    # åˆ›å»ºæ–‡ä»¶handlerï¼ˆç¦ç”¨ç¼“å†²ï¼‰
    file_handler = logging.FileHandler(log_filepath, encoding='utf-8', mode='w')
    file_handler.setLevel(logging.INFO)

    # åˆ›å»ºæ§åˆ¶å°handlerï¼ˆç¦ç”¨ç¼“å†²ï¼‰
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(logging.INFO)
    console_handler.flush = sys.stdout.flush  # å¼ºåˆ¶åˆ·æ–°

    # åˆ›å»ºformatter
    formatter = logging.Formatter('%(message)s')
    file_handler.setFormatter(formatter)
    console_handler.setFormatter(formatter)

    # æ·»åŠ handlers
    logger.addHandler(file_handler)
    logger.addHandler(console_handler)

    return log_filepath


class QuestionGenerator:
    """è€ƒé¢˜ç”Ÿæˆå™¨"""

    # ä¸åŒç­‰çº§çš„å‡ºé¢˜æ•°é‡è¦æ±‚ï¼ˆæ³¨æ„ï¼šç­‰çº§ä»…å†³å®šé¢˜ç›®æ•°é‡ï¼Œä¸å½±å“é¢˜ç›®éš¾åº¦ï¼‰
    LEVEL_REQUIREMENTS = {
        "ä¸€çº§": {"å•é€‰": 3, "åˆ¤æ–­": 2, "å¤šé€‰": 2},  # å…±7é¢˜
        "äºŒçº§": {"å•é€‰": 3, "åˆ¤æ–­": 2, "å¤šé€‰": 2},  # å…±7é¢˜
        "ä¸‰çº§": {"å•é€‰": 3, "åˆ¤æ–­": 2, "å¤šé€‰": 2},  # å…±7é¢˜
        "å››çº§": {"å•é€‰": 4, "åˆ¤æ–­": 2, "å¤šé€‰": 0},  # å…±6é¢˜
        "äº”çº§": {"å•é€‰": 4, "åˆ¤æ–­": 2, "å¤šé€‰": 0},  # å…±6é¢˜
    }

    def __init__(self):
        """åˆå§‹åŒ–ç”Ÿæˆå™¨"""
        api_key = os.getenv("DASHSCOPE_API_KEY")
        if not api_key:
            raise ValueError("è¯·åœ¨.envæ–‡ä»¶ä¸­è®¾ç½®DASHSCOPE_API_KEY")

        self.client = OpenAI(
            api_key=api_key,
            base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
        )

    def extract_level_from_filename(self, filename: str) -> Optional[str]:
        """
        ä»æ–‡ä»¶åä¸­æå–ç­‰çº§ä¿¡æ¯

        Args:
            filename: æ–‡ä»¶å,ä¾‹å¦‚ "ä¸‰çº§3001-3010.xlsx"

        Returns:
            ç­‰çº§å­—ç¬¦ä¸²,å¦‚ "ä¸‰çº§",å¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›None
        """
        # åŒ¹é… "ä¸€çº§", "äºŒçº§", "ä¸‰çº§", "å››çº§", "äº”çº§"
        pattern = r'(ä¸€çº§|äºŒçº§|ä¸‰çº§|å››çº§|äº”çº§)'
        match = re.search(pattern, filename)

        if match:
            return match.group(1)
        else:
            return None

    def detect_file_format(self, filepath: str) -> str:
        """
        æ£€æµ‹xlsxæ–‡ä»¶çš„æ ¼å¼ç±»å‹

        Args:
            filepath: xlsxæ–‡ä»¶è·¯å¾„

        Returns:
            æ ¼å¼ç±»å‹: "format1"ã€"format2" æˆ– "format3"
        """
        wb = openpyxl.load_workbook(filepath)
        ws = wb.active

        # è¯»å–å‰3è¡Œåˆ¤æ–­æ ¼å¼
        rows = list(ws.iter_rows(min_row=1, max_row=3, values_only=True))

        # æ£€æŸ¥ç¬¬1è¡Œæ˜¯å¦åŒ…å«è¡¨å¤´å…³é”®å­—
        if len(rows) >= 1:
            row1 = rows[0]
            row1_str = ' '.join([str(cell) if cell else '' for cell in row1])
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºformat3ï¼ˆå››çº§æ–‡ä»¶æ ¼å¼ï¼‰
            # ç‰¹å¾ï¼šç¬¬1è¡ŒåŒ…å«"é‰´å®šèŒƒå›´"ä¸”ç¬¬6åˆ—ä¸º"é¢˜ç›®åºå·"
            if 'é‰´å®šèŒƒå›´' in row1_str and len(row1) > 5:
                col6_str = str(row1[5]) if row1[5] else ''
                if 'é¢˜ç›®åºå·' in col6_str:
                    wb.close()
                    return "format3"
            
            # å¦‚æœç¬¬1è¡ŒåŒ…å«"é¢˜ç›®åºå·"ã€"é‰´å®šç‚¹"ã€"èµ„æ–™"ç­‰å…³é”®å­—ï¼Œåˆ¤å®šä¸ºæ ¼å¼2
            if any(keyword in row1_str for keyword in ['é¢˜ç›®åºå·', 'é‰´å®šç‚¹', 'èµ„æ–™']):
                wb.close()
                return "format2"

        # æ£€æŸ¥ç¬¬2è¡Œæ˜¯å¦åŒ…å«è¡¨å¤´å…³é”®å­—ï¼ˆformat2çš„å¦ä¸€ç§æƒ…å†µï¼‰
        if len(rows) >= 2:
            row2 = rows[1]
            row2_str = ' '.join([str(cell) if cell else '' for cell in row2])
            # å¦‚æœç¬¬2è¡ŒåŒ…å«"é¢˜ç›®åºå·"ã€"é‰´å®šç‚¹"ã€"èµ„æ–™"ç­‰å…³é”®å­—ï¼Œåˆ¤å®šä¸ºæ ¼å¼2
            if any(keyword in row2_str for keyword in ['é¢˜ç›®åºå·', 'é‰´å®šç‚¹', 'èµ„æ–™']):
                wb.close()
                return "format2"

        # æ£€æŸ¥ç¬¬1è¡Œç¬¬1åˆ—æ˜¯å¦ä¸ºæ•°å­—ï¼ˆåºå·ï¼‰- format1çš„ç‰¹å¾
        if len(rows) >= 1 and rows[0][0]:
            first_cell = str(rows[0][0])
            if first_cell.isdigit():
                wb.close()
                return "format1"

        wb.close()
        return "format1"  # é»˜è®¤æ ¼å¼1

    def read_knowledge_points(self, filepath: str) -> List[Dict[str, str]]:
        """
        è¯»å–xlsxæ–‡ä»¶ä¸­çš„é‰´å®šç‚¹ä¿¡æ¯ï¼ˆè‡ªåŠ¨æ£€æµ‹æ ¼å¼ï¼‰

        Args:
            filepath: xlsxæ–‡ä»¶è·¯å¾„

        Returns:
            é‰´å®šç‚¹åˆ—è¡¨,æ¯ä¸ªå…ƒç´ åŒ…å« {"ç¼–å·": "...", "åç§°": "...", "å†…å®¹": "..."}
        """
        file_format = self.detect_file_format(filepath)
        logging.info(f"  æ£€æµ‹åˆ°æ–‡ä»¶æ ¼å¼: {file_format}")

        wb = openpyxl.load_workbook(filepath)
        ws = wb.active

        knowledge_points = []

        if file_format == "format1":
            # æ ¼å¼1: ç¬¬1åˆ—=åºå·, ç¬¬2åˆ—=ç¼–å·, ç¬¬3åˆ—=åç§°, ç¬¬4åˆ—=å†…å®¹
            for row in ws.iter_rows(min_row=1, values_only=True):
                if row[0] is None:  # è·³è¿‡ç©ºè¡Œ
                    continue

                # è·å–ç¼–å·å¹¶æ ‡å‡†åŒ–ï¼ˆå°†ä¸­æ–‡ç ´æŠ˜å·æ›¿æ¢ä¸ºè‹±æ–‡è¿å­—ç¬¦ï¼‰
                code = str(row[1]) if row[1] else ""
                code = code.replace('â€”', '-').replace('ï¼', '-')

                point = {
                    "åºå·": str(row[0]) if row[0] else "",
                    "ç¼–å·": code,  # ä½¿ç”¨æ ‡å‡†åŒ–åçš„ç¼–å·
                    "åç§°": str(row[2]) if row[2] else "",
                    "å†…å®¹": str(row[3]) if row[3] else "",
                }
                knowledge_points.append(point)

        elif file_format == "format2":
            # æ ¼å¼2: è·³è¿‡ç¬¬1è¡Œï¼ˆè¡¨å¤´ï¼‰, ç¬¬1åˆ—=ç¼–å·, ç¬¬2åˆ—=åç§°, ç¬¬3åˆ—=å†…å®¹ï¼ˆç´¢å¼•2ï¼‰
            for row in ws.iter_rows(min_row=2, values_only=True):
                # è·³è¿‡ç©ºè¡Œï¼ˆç¬¬1åˆ—ä¸ºç©ºï¼‰
                if row[0] is None or str(row[0]).strip() == "":
                    continue

                # è·å–ç¼–å·å¹¶æ ‡å‡†åŒ–ï¼ˆå°†ä¸­æ–‡ç ´æŠ˜å·æ›¿æ¢ä¸ºè‹±æ–‡è¿å­—ç¬¦ï¼‰
                code = str(row[0]).strip()
                # æ›¿æ¢ä¸­æ–‡ç ´æŠ˜å·ä¸ºè‹±æ–‡è¿å­—ç¬¦
                code = code.replace('â€”', '-').replace('ï¼', '-')
                
                # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„é‰´å®šç‚¹ç¼–å·ï¼ˆæ ¼å¼å¦‚ A-B-A-001ï¼‰
                if not code or len(code) < 5:
                    continue
                
                # è·³è¿‡è¡¨å¤´è¡Œï¼ˆå¦‚æœç¼–å·åŒ…å«"é¢˜ç›®åºå·"ç­‰å…³é”®å­—ï¼‰
                if any(keyword in code for keyword in ['é¢˜ç›®åºå·', 'é‰´å®šç‚¹', 'åºå·']):
                    continue

                point = {
                    "åºå·": code,  # ç¬¬1åˆ—å°±æ˜¯åºå·/ç¼–å·
                    "ç¼–å·": code,  # ä½¿ç”¨æ ‡å‡†åŒ–åçš„ç¼–å·
                    "åç§°": str(row[1]).strip() if len(row) > 1 and row[1] else "",
                    "å†…å®¹": str(row[2]).strip() if len(row) > 2 and row[2] else "",  # ç¬¬3åˆ—æ˜¯å†…å®¹
                }
                knowledge_points.append(point)

        else:  # format3
            # æ ¼å¼3: å››çº§æ–‡ä»¶æ ¼å¼ï¼Œè·³è¿‡ç¬¬1è¡Œï¼ˆè¡¨å¤´ï¼‰
            # ç¬¬6åˆ—ï¼ˆç´¢å¼•5ï¼‰=ç¼–å·, ç¬¬7åˆ—ï¼ˆç´¢å¼•6ï¼‰=åç§°, ç¬¬9åˆ—ï¼ˆç´¢å¼•8ï¼‰=å†…å®¹
            for row in ws.iter_rows(min_row=2, values_only=True):
                # è·³è¿‡ç©ºè¡Œï¼ˆç¬¬6åˆ—ä¸ºç©ºï¼‰
                if len(row) <= 5 or row[5] is None or str(row[5]).strip() == "":
                    continue

                # è·å–ç¼–å·å¹¶æ ‡å‡†åŒ–ï¼ˆå°†ä¸­æ–‡ç ´æŠ˜å·æ›¿æ¢ä¸ºè‹±æ–‡è¿å­—ç¬¦ï¼‰
                code = str(row[5]).strip()
                # æ›¿æ¢ä¸­æ–‡ç ´æŠ˜å·ä¸ºè‹±æ–‡è¿å­—ç¬¦
                code = code.replace('â€”', '-').replace('ï¼', '-')
                
                # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„é‰´å®šç‚¹ç¼–å·ï¼ˆæ ¼å¼å¦‚ B-D-A-001ï¼‰
                if not code or len(code) < 5 or '-' not in code:
                    continue
                
                # è·³è¿‡è¡¨å¤´è¡Œ
                if any(keyword in code for keyword in ['é¢˜ç›®åºå·', 'é‰´å®šç‚¹', 'åºå·']):
                    continue

                point = {
                    "åºå·": code,  # ä½¿ç”¨ç¼–å·ä½œä¸ºåºå·
                    "ç¼–å·": code,  # ä½¿ç”¨æ ‡å‡†åŒ–åçš„ç¼–å·
                    "åç§°": str(row[6]).strip() if len(row) > 6 and row[6] else "",
                    "å†…å®¹": str(row[8]).strip() if len(row) > 8 and row[8] else "",
                }
                knowledge_points.append(point)

        wb.close()
        return knowledge_points


    def generate_all_questions_at_once(self, knowledge_point: Dict[str, str],
                                      level: str) -> Optional[List[Dict]]:
        """
        ä¸€æ¬¡æ€§ç”Ÿæˆä¸€ä¸ªé‰´å®šç‚¹çš„æ‰€æœ‰é¢˜ç›®ï¼ˆé¿å…é‡å¤ï¼‰

        Args:
            knowledge_point: é‰´å®šç‚¹ä¿¡æ¯
            level: ç­‰çº§ï¼ˆä»…ç”¨äºç¡®å®šé¢˜ç›®æ•°é‡ï¼Œä¸å½±å“éš¾åº¦ï¼‰

        Returns:
            é¢˜ç›®åˆ—è¡¨ï¼Œå¦‚æœç”Ÿæˆå¤±è´¥è¿”å›None
        """
        # æ£€æŸ¥çŸ¥è¯†ç‚¹å†…å®¹æ˜¯å¦ä¸ºç©º
        content = knowledge_point.get('å†…å®¹', '').strip()
        if not content:
            logging.error(f"  âŒ é”™è¯¯ï¼šé‰´å®šç‚¹å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆé¢˜ç›®")
            logging.error(f"  é‰´å®šç‚¹ç¼–å·: {knowledge_point.get('ç¼–å·', 'æœªçŸ¥')}")
            logging.error(f"  é‰´å®šç‚¹åç§°: {knowledge_point.get('åç§°', 'æœªçŸ¥')}")
            sys.stdout.flush()
            return None
        
        requirements = self.LEVEL_REQUIREMENTS[level]

        # æ„å»ºpromptï¼Œä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰é¢˜ç›®
        prompt = f"""
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•å‘½é¢˜ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹çŸ¥è¯†ç‚¹å†…å®¹ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆè¯¥é‰´å®šç‚¹çš„å…¨éƒ¨è€ƒé¢˜ã€‚

ã€çŸ¥è¯†ç‚¹ä¿¡æ¯ã€‘
é‰´å®šç‚¹ç¼–å·: {knowledge_point['ç¼–å·']}
é‰´å®šç‚¹åç§°: {knowledge_point['åç§°']}
çŸ¥è¯†ç‚¹å†…å®¹: {knowledge_point['å†…å®¹']}

ã€ç‰¹åˆ«æ³¨æ„ã€‘
âš ï¸ çŸ¥è¯†ç‚¹å†…å®¹ä¸­å¯èƒ½åŒ…å«è§„èŒƒä¹¦åå’Œç« èŠ‚ç¼–å·ï¼ˆå¦‚"ã€Šæ··å‡åœŸç»“æ„è®¾è®¡è§„èŒƒã€‹9.2.4æ¡"ï¼‰ï¼Œè¿™äº›ä»…æ˜¯**å‚è€ƒæ¥æº**ï¼š
- ä¹¦åå’Œç« èŠ‚å·**åªèƒ½å‡ºç°åœ¨çŸ¥è¯†ç‚¹å†…å®¹ä¸­**ï¼Œä½œä¸ºè¯´æ˜æ¥æº
- **é¢˜å¹²å’Œé€‰é¡¹ä¸­å¿…é¡»å®Œå…¨åˆ é™¤è¿™äº›ç« èŠ‚ç¼–å·**
- **å¿…é¡»ä»çŸ¥è¯†ç‚¹å†…å®¹ä¸­æå–å®è´¨æ€§çš„è§„å®šã€æ•°å€¼ã€æ–¹æ³•ã€è¦æ±‚ç­‰ä½œä¸ºè€ƒç‚¹**
- **ç»å¯¹ä¸èƒ½è€ƒæŸ¥"éµå¾ªå“ªä¸€æ¡è§„å®š"è¿™ç§è¦æ±‚è®°ä½ç« èŠ‚ç¼–å·çš„é¢˜ç›®**

ğŸ“Œ å¤„ç†ç¤ºä¾‹ï¼š
çŸ¥è¯†ç‚¹å†…å®¹ï¼š"ã€Šæ··å‡åœŸç»“æ„è®¾è®¡è§„èŒƒã€‹9.2.4æ¡è§„å®šï¼Œåº”æœ‰ä¸å°‘äº2æ ¹ä¸Šéƒ¨é’¢ç­‹ä¼¸è‡³å¤–ç«¯ï¼Œå¹¶å‘ä¸‹å¼¯æŠ˜ä¸å°äº12d"
- âŒ é”™è¯¯å‡ºé¢˜ï¼š"ï¼ˆ   ï¼‰è§„å®šäº†é’¢ç­‹åº”ä¼¸è‡³å¤–ç«¯" â†’ é€‰é¡¹éƒ½æ˜¯ç« èŠ‚å·
- âœ… æ­£ç¡®å‡ºé¢˜ï¼š"æ‚¬è‡‚æ¢ä¸­åº”æœ‰ä¸å°‘äºï¼ˆ   ï¼‰æ ¹ä¸Šéƒ¨é’¢ç­‹ä¼¸è‡³å¤–ç«¯" â†’ é€‰é¡¹æ˜¯"1/2/3/4"
- âœ… æ­£ç¡®å‡ºé¢˜ï¼š"ä¸Šéƒ¨é’¢ç­‹å‘ä¸‹å¼¯æŠ˜ä¸å°äºï¼ˆ   ï¼‰" â†’ é€‰é¡¹æ˜¯"10d/12d/15d/20d"

ã€å‡ºé¢˜è¦æ±‚ã€‘
1. é¢˜ç›®éš¾åº¦é€‚ä¸­
2. é¢˜ç›®å†…å®¹å¿…é¡»ä¸¥æ ¼åŸºäºæä¾›çš„çŸ¥è¯†ç‚¹å†…å®¹ï¼ˆæå–å®è´¨å†…å®¹ï¼Œå¿½ç•¥ç« èŠ‚ç¼–å·ï¼‰
3. âš ï¸ ã€æ ¸å¿ƒè¦æ±‚ã€‘é¢˜ç›®å¿…é¡»èšç„¦æ ¸å¿ƒçŸ¥è¯†ç‚¹
   - **è¯†åˆ«æ ¸å¿ƒçŸ¥è¯†ç‚¹**: ä»”ç»†åˆ†æçŸ¥è¯†ç‚¹å†…å®¹ï¼Œæ‰¾å‡ºæœ€æ ¸å¿ƒã€æœ€å…³é”®çš„æ¦‚å¿µã€åŸåˆ™ã€æ–¹æ³•ã€å®šä¹‰ç­‰
   - **é¢˜ç›®èšç„¦æ ¸å¿ƒ**: é¢˜ç›®çš„è€ƒæŸ¥ç‚¹å¿…é¡»æ˜¯è¿™äº›æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œè€Œä¸æ˜¯å¥å°¾çš„ä¿®é¥°æ€§å†…å®¹
   - **é¿å…å½¢å¼ä¸»ä¹‰**: ä¸è¦æœºæ¢°åœ°å°†çŸ¥è¯†ç‚¹å†…å®¹çš„æœ€åéƒ¨åˆ†ä½œä¸ºè€ƒæŸ¥ç‚¹
   - ğŸ“Œ **ç¤ºä¾‹è¯´æ˜**:
     * å¦‚æœçŸ¥è¯†ç‚¹å†…å®¹æ˜¯"è´£ä»»æ„è¯†ä¸æ‹…å½“ç²¾ç¥æ˜¯è¡Œä¸ºçš„åŸºçŸ³ä¸é£éª¨"
     * âŒ é”™è¯¯åšæ³•: è´£ä»»æ„è¯†ä¸æ‹…å½“ç²¾ç¥æ˜¯è¡Œä¸ºçš„ï¼ˆ   ï¼‰[è€ƒæŸ¥"åŸºçŸ³ä¸é£éª¨"è¿™ä¸ªå¥å°¾å†…å®¹]
     * âœ… æ­£ç¡®åšæ³•: ï¼ˆ   ï¼‰æ˜¯è¡Œä¸ºçš„åŸºçŸ³ä¸é£éª¨ [è€ƒæŸ¥æ ¸å¿ƒ"è´£ä»»æ„è¯†ä¸æ‹…å½“ç²¾ç¥"]
4. âš ï¸ ã€å…³é”®ã€‘æ­£ç¡®ç­”æ¡ˆå¿…é¡»åœ¨çŸ¥è¯†ç‚¹åŸæ–‡ä¸­ç›´æ¥å‡ºç°
   - æ­£ç¡®ç­”æ¡ˆçš„è¡¨è¿°å¿…é¡»åœ¨çŸ¥è¯†ç‚¹åŸæ–‡ä¸­é€å­—é€å¥åœ°å‡ºç°
   - ä¸å…è®¸æ¨å¯¼ã€ä¸å…è®¸å¼•ç”³ã€ä¸å…è®¸è”æƒ³
   - ä¸èƒ½ä½¿ç”¨çŸ¥è¯†ç‚¹ä¸­æœªæåŠçš„ä¸“ä¸šæœ¯è¯­æˆ–æ¦‚å¿µä½œä¸ºç­”æ¡ˆ
   - ä¸èƒ½åŸºäºå¤–éƒ¨çŸ¥è¯†æˆ–å¸¸è¯†ç¼–é€ ç­”æ¡ˆ
   - å¦‚æœçŸ¥è¯†ç‚¹ä¸­æ²¡æœ‰æ˜ç¡®å†™å‡ºæŸä¸ªæ¦‚å¿µï¼Œå°±ä¸èƒ½å°†å…¶ä½œä¸ºç­”æ¡ˆ
   - è¿åæ­¤è§„åˆ™çš„é¢˜ç›®ä¸€å¾‹æ— æ•ˆ
4. é¢˜å¹²å¿…é¡»æ˜¯é™ˆè¿°å¥ï¼Œä»¥å¥å·ç»“æŸï¼Œä¸èƒ½æ˜¯ç–‘é—®å¥
5. é¢˜å¹²ä¸­ä¸èƒ½æœ‰æ¢è¡Œç¬¦
6. ç›¸åŒçŸ¥è¯†ç‚¹å¯ä»¥ç”¨ä¸åŒé¢˜ç›®è¿›è¡Œè€ƒæŸ¥ï¼Œä½†ä¸¥ç¦é¢˜ç›®é‡å¤ã€‚
7. âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²ä¸­ä¸¥ç¦å‡ºç°"é‰´å®šç‚¹"ã€"çŸ¥è¯†ç‚¹"ç­‰æŒ‡å‘ä¸æ˜çš„è¯æ±‡
   - ä¸èƒ½å‡ºç°"é‰´å®šç‚¹ä¸­"ã€"çŸ¥è¯†ç‚¹ä¸­"ã€"è¯¥çŸ¥è¯†ç‚¹"ç­‰è¡¨è¿°
   - é¢˜å¹²å¿…é¡»ç›´æ¥æè¿°å…·ä½“å†…å®¹ï¼Œä¸èƒ½å¼•ç”¨"çŸ¥è¯†ç‚¹"è¿™ä¸ªå…ƒæ¦‚å¿µ
   - âŒ é”™è¯¯ç¤ºä¾‹ï¼šè¯šä¿¡æ­£ç›´çš„å“æ ¼åœ¨çŸ¥è¯†ç‚¹ä¸­è¢«æè¿°ä¸ºï¼ˆ   ï¼‰
   - âœ… æ­£ç¡®ç¤ºä¾‹ï¼šè¯šä¿¡æ­£ç›´çš„å“æ ¼è¢«æè¿°ä¸ºï¼ˆ   ï¼‰
8. âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²ä¸­ä¸¥ç¦å‡ºç°"ï¼ˆ   ï¼‰ç­‰"è¿™ç§æ¨¡ç³Šè¡¨è¿°
   - "ï¼ˆ   ï¼‰ç­‰"æš—ç¤ºè¿˜æœ‰å…¶ä»–æœªåˆ—ä¸¾çš„é€‰é¡¹ï¼Œä¼šé€ æˆç­”æ¡ˆä¸å”¯ä¸€æˆ–æœ‰äº‰è®®
   - é¢˜ç›®å¿…é¡»èšç„¦åœ¨ç¡®å®šæ€§çš„æ ¸å¿ƒæ¦‚å¿µä¸Šï¼Œä¸èƒ½è®©å­¦ç”ŸçŒœæµ‹"è¿˜æœ‰å“ªäº›"
   - âŒ é”™è¯¯ç¤ºä¾‹ï¼šè¡Œä¸ºé”šå®šç­‰çº§è¯„ä»·æ³•é’ˆå¯¹ï¼ˆ   ï¼‰ç­‰ç»´åº¦ï¼Œä¸ºæ¯ä¸ªç»©æ•ˆç­‰çº§é”šå®šå…¸å‹è¡Œä¸ºèŒƒä¾‹
   - âœ… æ­£ç¡®åšæ³•ï¼šè€ƒæŸ¥ç¡®å®šæ€§æ¦‚å¿µï¼Œå¦‚"ï¼ˆ   ï¼‰æ˜¯ä¸ºæ¯ä¸ªç»©æ•ˆç­‰çº§é”šå®šå…¸å‹è¡Œä¸ºèŒƒä¾‹çš„æ–¹æ³•"
   - ğŸ“Œ åˆ¤æ–­æ ‡å‡†ï¼šå¦‚æœé¢˜å¹²åŒ…å«"ï¼ˆ   ï¼‰ç­‰"ï¼Œè¿™é¢˜å°±æ˜¯è¿è§„çš„
9. âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²å’Œé€‰é¡¹ä¸­ä¸¥ç¦å‡ºç°å›¾è¡¨å¼•ç”¨
   - ä¸èƒ½å‡ºç°"å›¾X.X"ã€"è¡¨X.X"ã€"é™„å›¾"ã€"è§å›¾"ç­‰å›¾è¡¨å¼•ç”¨
   - ä¸èƒ½å‡ºç°"å¦‚å›¾æ‰€ç¤º"ã€"å‚è§è¡¨æ ¼"ç­‰è¡¨è¿°
   - æ‰€æœ‰é¢˜ç›®å¿…é¡»æ˜¯çº¯æ–‡å­—æè¿°ï¼Œä¸ä¾èµ–ä»»ä½•å›¾è¡¨
10. âš ï¸ ã€ç¦æ­¢ã€‘ä¸¥ç¦å‡º"ä¾‹å¦‚"é¢˜æˆ–"ä¸¾ä¾‹"é¢˜
   - âŒ ä¸¥ç¦é¢˜å¹²ä¸­å‡ºç°"ä¾‹å¦‚ï¼ˆ   ï¼‰"è¿™ç§è®©å­¦ç”Ÿé€‰æ‹©ä¾‹å­çš„æ ¼å¼
   - âŒ ä¸¥ç¦è®©å­¦ç”Ÿä»å‡ ä¸ªä¾‹å­ä¸­é€‰æ‹©çŸ¥è¯†ç‚¹ç»™å‡ºçš„ä¾‹å­
   - âŒ ä¸¥ç¦è€ƒå¯Ÿ"ä¾‹å¦‚XXã€YY"ä¸­çš„å…·ä½“ä¾‹å­æ˜¯å“ªä¸ª
   - âœ… é¢˜ç›®åº”è¯¥è€ƒå¯Ÿæ¦‚å¿µã€è§„åˆ™ã€æ–¹æ³•ï¼Œè€Œä¸æ˜¯è®°ä½ä¾‹å­
   - âœ… å¦‚æœçŸ¥è¯†ç‚¹åªç»™äº†ä¾‹å­æ²¡æœ‰è§£é‡Šï¼Œåº”è¯¥è€ƒå¯Ÿä¾‹å­èƒŒåçš„è§„å¾‹æˆ–ç‰¹å¾
   - ğŸ“Œ åˆ¤æ–­æ ‡å‡†ï¼šå¦‚æœé¢˜å¹²åŒ…å«"ä¾‹å¦‚ï¼ˆ   ï¼‰"æˆ–"å¦‚ï¼ˆ   ï¼‰"ï¼Œè¿™é¢˜å°±æ˜¯è¿è§„çš„
11. âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²å’Œé€‰é¡¹ä¸­ä¸¥ç¦å‡ºç°ç« èŠ‚ç¼–å·æˆ–ä¹¦ç±ç›®å½•ä¿¡æ¯
   - âŒ é¢˜å¹²ä¸­ä¸èƒ½å‡ºç°"5.2.4"ã€"ç¬¬3ç« "ã€"9.2.7æ¡"ç­‰ç« èŠ‚ç¼–å·
   - âŒ é¢˜å¹²ä¸­ä¸èƒ½å‡ºç°"æ ¹æ®5.2.4è§„å®š"ã€"æŒ‰ç…§ç¬¬3ç« è¦æ±‚"ç­‰å¼•ç”¨ç« èŠ‚çš„è¡¨è¿°
   - âŒ **é€‰é¡¹ä¸­ç»å¯¹ä¸èƒ½å‡ºç°ç« èŠ‚ç¼–å·**ï¼ˆå¦‚"9.2.7æ¡"ã€"5.2.4"ã€"ç¬¬3ç« "ç­‰ï¼‰
   - âŒ **ä¸¥ç¦è€ƒæŸ¥"åº”è¯¥éµå¾ªå“ªä¸€æ¡è§„å®š"è¿™ç±»è¦æ±‚å­¦ç”Ÿè®°ä½ç« èŠ‚ç¼–å·çš„é¢˜ç›®**
   - åŸå› ï¼š
     * ç« èŠ‚ä¿¡æ¯æ¥è‡ªå‚è€ƒä¹¦ç›®å½•ï¼Œä¼šå¼•å¯¼å­¦ç”ŸæŸ¥æ‰¾ä¹¦ç±
     * è€ƒæŸ¥ç« èŠ‚ç¼–å·æœ¬èº«æ¯«æ— æ„ä¹‰ï¼Œæ˜¯ä½è´¨é‡å‡ºé¢˜
     * åº”è¯¥è€ƒæŸ¥çŸ¥è¯†ç‚¹çš„å®è´¨å†…å®¹ï¼Œè€Œä¸æ˜¯å®ƒåœ¨ä¹¦ä¸­çš„ä½ç½®
   - âœ… æ­£ç¡®åšæ³•ï¼š
     * ä»çŸ¥è¯†ç‚¹å†…å®¹ä¸­æå–å®è´¨æ€§çš„è§„å®šã€è¦æ±‚ã€æ•°å€¼ã€æ–¹æ³•ç­‰
     * ç›´æ¥é™ˆè¿°çŸ¥è¯†ç‚¹å†…å®¹ï¼Œä¸å¼•ç”¨ç« èŠ‚å·
     * è€ƒæŸ¥å­¦ç”Ÿå¯¹çŸ¥è¯†ç‚¹æœ¬èº«çš„ç†è§£ï¼Œè€Œéå¯¹ç›®å½•çš„è®°å¿†
   - ğŸ“Œ ç¤ºä¾‹ï¼š
     * âŒ é”™è¯¯é¢˜å¹²ï¼š"æ ¹æ®9.2.4æ¡è§„å®šï¼Œä¸ŠæŸ±æ’ç­‹åº”åŒ…æ‹¬åœ¨ï¼ˆ   ï¼‰ä¸­"
     * âŒ é”™è¯¯é€‰é¡¹ï¼š"A) 9.2.7æ¡  B) 9.2.4æ¡  C) 9.2.8æ¡  D) 9.1.3æ¡"
     * âœ… æ­£ç¡®é¢˜å¹²ï¼š"é’¢ç­‹æ··å‡åœŸæ‚¬è‡‚æ¢ä¸­ï¼Œåº”æœ‰ä¸å°‘äºï¼ˆ   ï¼‰æ ¹ä¸Šéƒ¨é’¢ç­‹ä¼¸è‡³æ‚¬è‡‚æ¢å¤–ç«¯"
     * âœ… æ­£ç¡®é€‰é¡¹ï¼š"A) 1  B) 2  C) 3  D) 4"
12. âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²å’Œé€‰é¡¹ä¸­ä¸¥ç¦å‡ºç°å…·ä½“å›¾çº¸å¼•ç”¨
   - âŒ ä¸èƒ½å‡ºç°"å¦‚å›¾ä¸€æ‰€ç¤º"ã€"å›¾Xæ‰€ç¤º"ã€"æ ¹æ®å›¾çº¸"ç­‰å¼•ç”¨å…·ä½“å›¾çº¸çš„è¡¨è¿°
   - âŒ ä¸èƒ½å‡ºç°"è§é™„å›¾"ã€"å‚è€ƒç¤ºæ„å›¾"ã€"ä¸‹å›¾ä¸­"ç­‰éœ€è¦é…å›¾çš„è¡¨è¿°
   - âŒ ä¸èƒ½å‡ºç°"å›¾ä¸­çš„XX"ã€"å›¾ç¤ºç»“æ„"ç­‰ä¾èµ–å›¾çº¸ç†è§£çš„å†…å®¹
   - åŸå› ï¼šè€ƒé¢˜ä¸­ä¸é™„å¸¦è¯¦ç»†çš„å›¾çº¸ï¼Œå­¦ç”Ÿæ— æ³•çœ‹åˆ°å›¾çº¸å†…å®¹
   - âœ… æ­£ç¡®åšæ³•ï¼šç”¨æ–‡å­—å®Œæ•´æè¿°æ‰€æœ‰ä¿¡æ¯ï¼Œç¡®ä¿ä¸çœ‹å›¾ä¹Ÿèƒ½ç†è§£å’Œä½œç­”
   - ğŸ“Œ ç¤ºä¾‹ï¼š
     * âŒ é”™è¯¯ï¼š"å¦‚å›¾ä¸€æ‰€ç¤ºï¼ŒæŸ±å˜æˆªé¢å¤„çš„é’¢ç­‹åº”å¦‚ä½•é…ç½®ï¼Ÿ"
     * âœ… æ­£ç¡®ï¼š"æŸ±å˜æˆªé¢å¤„ä¸ŠæŸ±æ’ç­‹ä¸ä¸‹æŸ±é’¢ç­‹ä¸€åŒå®‰è£…æ—¶ï¼Œä¸ŠæŸ±æ’ç­‹åº”åŒ…æ‹¬åœ¨å“ªé‡Œï¼Ÿ"

ã€çŸ¥è¯†è¦†ç›–è¦æ±‚ã€‘
å¿…é¡»ç¡®ä¿é¢˜ç›®è¦†ç›–ä»¥ä¸‹ä¸¤ä¸ªå±‚é¢ï¼š

ä¸€ã€åŸºç¡€ä¸”æ ¸å¿ƒçš„çŸ¥è¯†ç‚¹ï¼ˆå®è§‚å±‚é¢ï¼‰ï¼š
   - åŸºæœ¬å®šä¹‰ï¼šè¯¥çŸ¥è¯†ç‚¹çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ä»€ä¹ˆ
   - åˆ†ç±»ä½“ç³»ï¼šåˆ†ä¸ºå“ªå‡ ç±»ã€æœ‰å“ªäº›ç±»å‹
   - ç»„æˆæ¡†æ¶ï¼šç”±å“ªäº›éƒ¨åˆ†æ„æˆã€åŒ…å«å“ªäº›è¦ç´ 
   - è¡¨è¾¾æ–¹å¼ï¼šå¦‚ä½•è¡¨ç¤ºã€å¦‚ä½•å‘½å
   - æ•´ä½“é€»è¾‘ï¼šéµå¾ªä»€ä¹ˆåŸåˆ™ã€æœ‰ä»€ä¹ˆè§„å¾‹

äºŒã€å…·ä½“å†…å®¹ç»†èŠ‚ï¼ˆå¾®è§‚å±‚é¢ï¼‰ï¼š
   - å…³é”®å‚æ•°ï¼šå…·ä½“çš„æ•°å€¼ã€å°ºå¯¸ã€èŒƒå›´
   - ç¬¦å·è§„åˆ™ï¼šä½¿ç”¨ä»€ä¹ˆç¬¦å·ã€ç¬¦å·å«ä¹‰
   - æ ‡æ³¨æ–¹æ³•ï¼šå¦‚ä½•ä¹¦å†™ã€å¦‚ä½•æ ‡æ³¨
   - æ•°å€¼è§„å®šï¼šå…·ä½“è§„å®šçš„æ•°å€¼æˆ–æ¯”ä¾‹
   - æ¡ä»¶é™åˆ¶ï¼šä»€ä¹ˆæƒ…å†µä¸‹é€‚ç”¨ã€æœ‰ä½•é™åˆ¶
   - ä¾‹å¤–æƒ…å†µï¼šç‰¹æ®Šæƒ…å†µçš„å¤„ç†
   - å…¸å‹ç¤ºä¾‹ï¼šå¸¸è§çš„åº”ç”¨å®ä¾‹

ğŸ’¡ å‡ºé¢˜æ—¶å¿…é¡»ç¡®ä¿ï¼š
   - æ—¢æœ‰å¯¹å®è§‚çŸ¥è¯†ç‚¹çš„è€ƒæŸ¥ï¼Œä¹Ÿæœ‰å¯¹å¾®è§‚çŸ¥è¯†ç‚¹çš„è€ƒæŸ¥
   - é¢˜ç›®åº”å…¨é¢è¦†ç›–çŸ¥è¯†ç‚¹çš„ç†è®ºå’Œå®è·µä¸¤ä¸ªç»´åº¦

ã€é¢˜ç›®æ•°é‡ã€‘
- å•é€‰é¢˜ï¼š{requirements['å•é€‰']}é“ï¼ˆæ¯é¢˜4ä¸ªé€‰é¡¹ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆï¼‰
- åˆ¤æ–­é¢˜ï¼š{requirements['åˆ¤æ–­']}é“ï¼ˆç­”æ¡ˆä¸º"æ­£ç¡®"æˆ–"é”™è¯¯"ï¼‰
- å¤šé€‰é¢˜ï¼š{requirements['å¤šé€‰']}é“ï¼ˆæ¯é¢˜5ä¸ªé€‰é¡¹ï¼Œæœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ­£ç¡®ç­”æ¡ˆï¼‰

ã€å•é€‰é¢˜è¦æ±‚ã€‘
- é¢˜å¹²ä¸­è¦æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‹¬å·"ï¼ˆ   ï¼‰"ç”¨äºå¡«ç©º
- âš ï¸ æ‹¬å·ä½ç½®è¦æœ‰å¤šæ ·æ€§ï¼šåœ¨åŒä¸€é‰´å®šç‚¹çš„æ‰€æœ‰å•é€‰é¢˜å’Œå¤šé€‰é¢˜ä¸­ï¼Œæ‹¬å·ä¸èƒ½éƒ½å‡ºç°åœ¨é¢˜å¹²å°¾éƒ¨
  * è‡³å°‘è¦æœ‰éƒ¨åˆ†é¢˜ç›®çš„æ‹¬å·å‡ºç°åœ¨é¢˜å¹²çš„å¼€å¤´ã€ä¸­é—´ç­‰ä¸åŒä½ç½®
  * è¿™æ ·å¯ä»¥ä»å¤šè§’åº¦è€ƒæŸ¥çŸ¥è¯†ç‚¹ï¼Œé¿å…å‡ºé¢˜æ¨¡å¼å•ä¸€
- å¿…é¡»æä¾›4ä¸ªé€‰é¡¹(Aã€Bã€Cã€D)
- æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ
- âš ï¸ 4ä¸ªé€‰é¡¹çš„å†…å®¹å¿…é¡»å„ä¸ç›¸åŒï¼Œä¸èƒ½æœ‰é‡å¤
- å…¶ä»–ä¸‰ä¸ªé€‰é¡¹åº”è¯¥å…·æœ‰ä¸€å®šçš„å¹²æ‰°æ€§ï¼Œä¸èƒ½æ˜æ˜¾é”™è¯¯
- é€‰é¡¹å†…å®¹ç®€æ´ï¼Œä¸æ¢è¡Œ

ã€åˆ¤æ–­é¢˜è¦æ±‚ã€‘
- é¢˜å¹²æ˜¯ä¸€ä¸ªé™ˆè¿°å¥ï¼Œä»¥å¥å·ç»“æŸ
- ä¸éœ€è¦æ‹¬å·
- ä¸éœ€è¦é€‰é¡¹
- é¢˜ç›®çš„é™ˆè¿°å¯ä»¥æ˜¯æ­£ç¡®çš„(ç­”æ¡ˆä¸º"æ­£ç¡®")ï¼Œä¹Ÿå¯ä»¥æ˜¯é”™è¯¯çš„(ç­”æ¡ˆä¸º"é”™è¯¯")
- å¦‚æœæ˜¯é”™è¯¯çš„é™ˆè¿°ï¼Œé”™è¯¯ç‚¹åº”è¯¥å…·æœ‰ä¸€å®šçš„è¿·æƒ‘æ€§

ã€å¤šé€‰é¢˜è¦æ±‚ã€‘
- é¢˜å¹²ä¸­è¦æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‹¬å·"ï¼ˆ   ï¼‰"ç”¨äºå¡«ç©º
- âš ï¸ æ‹¬å·ä½ç½®è¦æœ‰å¤šæ ·æ€§ï¼šåœ¨åŒä¸€é‰´å®šç‚¹çš„æ‰€æœ‰å•é€‰é¢˜å’Œå¤šé€‰é¢˜ä¸­ï¼Œæ‹¬å·ä¸èƒ½éƒ½å‡ºç°åœ¨é¢˜å¹²å°¾éƒ¨
  * è‡³å°‘è¦æœ‰éƒ¨åˆ†é¢˜ç›®çš„æ‹¬å·å‡ºç°åœ¨é¢˜å¹²çš„å¼€å¤´ã€ä¸­é—´ç­‰ä¸åŒä½ç½®
  * è¿™æ ·å¯ä»¥ä»å¤šè§’åº¦è€ƒæŸ¥çŸ¥è¯†ç‚¹ï¼Œé¿å…å‡ºé¢˜æ¨¡å¼å•ä¸€
- å¿…é¡»æä¾›5ä¸ªé€‰é¡¹(Aã€Bã€Cã€Dã€E)
- æ­£ç¡®ç­”æ¡ˆæœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Š
- âš ï¸ 5ä¸ªé€‰é¡¹çš„å†…å®¹å¿…é¡»å„ä¸ç›¸åŒï¼Œä¸èƒ½æœ‰é‡å¤
- å…¶ä»–é€‰é¡¹åº”è¯¥å…·æœ‰ä¸€å®šçš„å¹²æ‰°æ€§
- é€‰é¡¹å†…å®¹ç®€æ´ï¼Œä¸æ¢è¡Œ
- ç­”æ¡ˆå­—æ®µä¸­å¤šä¸ªé€‰é¡¹å­—æ¯ä¹‹é—´ä¸è¦ç”¨é—´éš”ç¬¦å·ï¼ˆå¦‚ï¼šABCã€BDEï¼‰

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼ŒåŒ…å«ä¸€ä¸ª"é¢˜ç›®åˆ—è¡¨"æ•°ç»„ï¼Œæ¯ä¸ªé¢˜ç›®åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
{{
    "é¢˜ç›®åˆ—è¡¨": [
        {{
            "é¢˜ç›®ç±»å‹": "å•é€‰",
            "é¢˜å¹²": "é¢˜ç›®å†…å®¹ï¼ˆ   ï¼‰ã€‚",
            "é€‰é¡¹A": "é€‰é¡¹Aå†…å®¹",
            "é€‰é¡¹B": "é€‰é¡¹Bå†…å®¹",
            "é€‰é¡¹C": "é€‰é¡¹Cå†…å®¹",
            "é€‰é¡¹D": "é€‰é¡¹Då†…å®¹",
            "ç­”æ¡ˆ": "B"
        }},
        {{
            "é¢˜ç›®ç±»å‹": "åˆ¤æ–­",
            "é¢˜å¹²": "é¢˜ç›®é™ˆè¿°å†…å®¹ã€‚",
            "ç­”æ¡ˆ": "æ­£ç¡®"
        }},
        {{
            "é¢˜ç›®ç±»å‹": "å¤šé€‰",
            "é¢˜å¹²": "é¢˜ç›®å†…å®¹ï¼ˆ   ï¼‰ã€‚",
            "é€‰é¡¹A": "é€‰é¡¹Aå†…å®¹",
            "é€‰é¡¹B": "é€‰é¡¹Bå†…å®¹",
            "é€‰é¡¹C": "é€‰é¡¹Cå†…å®¹",
            "é€‰é¡¹D": "é€‰é¡¹Då†…å®¹",
            "é€‰é¡¹E": "é€‰é¡¹Eå†…å®¹",
            "ç­”æ¡ˆ": "ABC"
        }}
    ]
}}

æ³¨æ„ï¼š
1. ç¡®ä¿é¢˜ç›®ä¹‹é—´æ²¡æœ‰é‡å¤ï¼ŒåŒä¸€é¢˜å‹ä¸èƒ½è€ƒæŸ¥åŒä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œä½†ä¸åŒé¢˜å‹å¯ä»¥è€ƒæŸ¥åŒä¸€ä¸ªçŸ¥è¯†ç‚¹ã€‚
2. é¢˜ç›®é¡ºåºï¼šå…ˆå•é€‰é¢˜ï¼Œå†åˆ¤æ–­é¢˜ï¼Œæœ€åå¤šé€‰é¢˜
3. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°JSONæ ¼å¼è¾“å‡º
"""

        try:
            logging.info(f"  æ­£åœ¨è°ƒç”¨AIç”Ÿæˆé¢˜ç›®...")
            sys.stdout.flush()  # ç«‹å³åˆ·æ–°è¾“å‡º

            completion = self.client.chat.completions.create(
                model="qwen3-max",
                messages=[
                    {
                        "role": "system",
                        "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•å‘½é¢˜ä¸“å®¶ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§è¦æ±‚ç”Ÿæˆè€ƒé¢˜ï¼Œç¡®ä¿é¢˜ç›®è´¨é‡é«˜ã€æ²¡æœ‰é‡å¤ï¼Œä»¥JSONæ ¼å¼è¿”å›ã€‚"
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                response_format={"type": "json_object"}
            )

            logging.info(f"  AIå“åº”å®Œæˆï¼Œæ­£åœ¨è§£æç»“æœ...")
            sys.stdout.flush()  # ç«‹å³åˆ·æ–°è¾“å‡º

            json_string = completion.choices[0].message.content
            
            # è®°å½•åŸå§‹å“åº”ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            logging.debug(f"  AIåŸå§‹å“åº”: {json_string[:500]}...")
            
            response_data = json.loads(json_string)

            # æå–é¢˜ç›®åˆ—è¡¨
            questions = response_data.get("é¢˜ç›®åˆ—è¡¨", [])
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆé¢˜ç›®
            if not questions:
                logging.warning(f"  âš ï¸  AIè¿”å›äº†ç©ºçš„é¢˜ç›®åˆ—è¡¨")
                logging.info(f"  å®Œæ•´å“åº”: {json_string}")
                return None

            # ä¸ºæ¯ä¸ªé¢˜ç›®æ·»åŠ é‰´å®šç‚¹ç¼–å·
            for q in questions:
                q["é‰´å®šç‚¹ç¼–å·"] = knowledge_point["ç¼–å·"]

            return questions

        except json.JSONDecodeError as e:
            logging.error(f"  âŒ JSONè§£æå¤±è´¥: {e}")
            logging.error(f"  AIå“åº”å†…å®¹: {json_string[:1000] if 'json_string' in locals() else 'æœªè·å–åˆ°å“åº”'}")
            sys.stdout.flush()
            return None
        except KeyError as e:
            logging.error(f"  âŒ å“åº”æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘å¿…è¦å­—æ®µ: {e}")
            logging.error(f"  å“åº”å†…å®¹: {response_data if 'response_data' in locals() else 'æœªè§£æ'}")
            sys.stdout.flush()
            return None
        except Exception as e:
            logging.error(f"  âŒ ç”Ÿæˆé¢˜ç›®æ—¶å‡ºé”™: {type(e).__name__}: {e}")
            sys.stdout.flush()
            return None

    def evaluate_questions(self, knowledge_point: Dict[str, str],
                          questions: List[Dict]) -> Dict:
        """
        è¯„ä¼°ç”Ÿæˆçš„é¢˜ç›®è´¨é‡

        Args:
            knowledge_point: é‰´å®šç‚¹ä¿¡æ¯
            questions: ç”Ÿæˆçš„é¢˜ç›®åˆ—è¡¨

        Returns:
            è¯„ä¼°ç»“æœï¼ŒåŒ…å«é—®é¢˜å’Œå»ºè®®
        """
        # æ„å»ºè¯„ä¼°prompt
        questions_text = json.dumps(questions, ensure_ascii=False, indent=2)

        prompt = f"""
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•è´¨é‡è¯„ä¼°ä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹ç”Ÿæˆçš„è€ƒé¢˜è¿›è¡Œå…¨é¢è¯„ä¼°ã€‚

ã€çŸ¥è¯†ç‚¹ä¿¡æ¯ã€‘
é‰´å®šç‚¹ç¼–å·: {knowledge_point['ç¼–å·']}
é‰´å®šç‚¹åç§°: {knowledge_point['åç§°']}
çŸ¥è¯†ç‚¹å†…å®¹: {knowledge_point['å†…å®¹']}

ã€ç”Ÿæˆçš„é¢˜ç›®ã€‘
{questions_text}

ã€è¯„ä¼°ç»´åº¦ã€‘
è¯·ä»ä»¥ä¸‹ç»´åº¦è¯„ä¼°é¢˜ç›®è´¨é‡ï¼š

1. **æœ‰æ•ˆæ€§æ£€æŸ¥å’Œé‡å¤æ€§æ£€æŸ¥**ï¼ˆâš ï¸ æœ€é‡è¦ï¼‰
   - âš ï¸ ã€å…³é”®ã€‘é¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆæ˜¯å¦åœ¨çŸ¥è¯†ç‚¹åŸæ–‡ä¸­é€å­—é€å¥åœ°å‡ºç°ï¼Ÿ
     * æ­£ç¡®ç­”æ¡ˆå¿…é¡»åœ¨çŸ¥è¯†ç‚¹åŸæ–‡ä¸­ç›´æ¥å‡ºç°ï¼Œé€å­—å¯æŸ¥
     * ä¸å…è®¸æ¨å¯¼ã€ä¸å…è®¸å¼•ç”³ã€ä¸å…è®¸è”æƒ³å¾—å‡ºç­”æ¡ˆ
     * ä¸èƒ½ä½¿ç”¨çŸ¥è¯†ç‚¹ä¸­æœªæåŠçš„ä¸“ä¸šæœ¯è¯­æˆ–æ¦‚å¿µ
     * ä¸èƒ½åŸºäºå¤–éƒ¨çŸ¥è¯†ç¼–é€ ç­”æ¡ˆ
     * è¿™æ˜¯æœ€é‡è¦çš„æ£€æŸ¥é¡¹ï¼Œè¿åæ­¤é¡¹å¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜
   - âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²å’Œé€‰é¡¹ä¸­æ˜¯å¦å‡ºç°äº†å›¾è¡¨å¼•ç”¨ï¼Ÿ
     * ä¸èƒ½å‡ºç°"å›¾X.X"ã€"è¡¨X.X"ã€"é™„å›¾"ã€"è§å›¾"ç­‰
     * ä¸èƒ½å‡ºç°"å¦‚å›¾æ‰€ç¤º"ã€"å‚è§è¡¨æ ¼"ç­‰è¡¨è¿°
     * è¿åæ­¤é¡¹å¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜
   - âš ï¸ ã€ç¦æ­¢ã€‘æ˜¯å¦å‡ºç°äº†"ä¾‹å¦‚"é¢˜æˆ–"ä¸¾ä¾‹"é¢˜ï¼Ÿ
     * âŒ æ£€æŸ¥é¢˜å¹²ä¸­æ˜¯å¦åŒ…å«"ä¾‹å¦‚ï¼ˆ   ï¼‰"æˆ–"å¦‚ï¼ˆ   ï¼‰"æ ¼å¼
     * âŒ æ£€æŸ¥æ˜¯å¦è®©å­¦ç”Ÿä»å‡ ä¸ªä¾‹å­ä¸­é€‰æ‹©çŸ¥è¯†ç‚¹ç»™å‡ºçš„ä¾‹å­
     * âŒ æ£€æŸ¥æ˜¯å¦è€ƒå¯Ÿ"ä¾‹å¦‚XXã€YY"ä¸­çš„å…·ä½“ä¾‹å­æ˜¯å“ªä¸ª
     * ğŸ“Œ ç‰¹åˆ«æ³¨æ„ï¼šå¦‚æœé¢˜å¹²æ˜¯"XXä¾‹å¦‚ï¼ˆ   ï¼‰"ï¼Œç­”æ¡ˆæ˜¯çŸ¥è¯†ç‚¹ä¸­çš„ä¾‹å­ï¼Œè¿™å°±æ˜¯è¿è§„
     * è¿åæ­¤é¡¹å¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜
   - âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²å’Œé€‰é¡¹ä¸­æ˜¯å¦å‡ºç°äº†ç« èŠ‚ç¼–å·ï¼Ÿã€é‡è¦ã€‘
     * âŒ é¢˜å¹²ä¸­æ˜¯å¦åŒ…å«"5.2.4"ã€"ç¬¬3ç« "ã€"9.2.7æ¡"ç­‰ç« èŠ‚ç¼–å·
     * âŒ é¢˜å¹²ä¸­æ˜¯å¦æœ‰"æ ¹æ®5.2.4è§„å®š"ã€"æŒ‰ç…§ç¬¬3ç« è¦æ±‚"ç­‰è¡¨è¿°
     * âŒ **é€‰é¡¹ä¸­æ˜¯å¦å‡ºç°ç« èŠ‚ç¼–å·**ï¼ˆå¦‚é€‰é¡¹ä¸º"A) 9.2.7æ¡"ã€"B) 5.2.4"ç­‰ï¼‰
     * âŒ **æ˜¯å¦åœ¨è€ƒæŸ¥"åº”éµå¾ªå“ªä¸€æ¡è§„å®š"è¿™ç±»è¦æ±‚è®°ä½ç« èŠ‚ç¼–å·çš„é¢˜ç›®**
     * ç‰¹åˆ«æ£€æŸ¥ï¼šå¦‚æœé€‰é¡¹éƒ½æ˜¯"X.X.Xæ¡"æ ¼å¼ï¼Œè¿™æ˜¯ä¸¥é‡çš„ä½è´¨é‡å‡ºé¢˜
     * åŸå› ï¼š
       - ç« èŠ‚ä¿¡æ¯ä¼šå¼•å¯¼å­¦ç”ŸæŸ¥æ‰¾ä¹¦ç±è€Œéè€ƒæŸ¥çŸ¥è¯†ç‚¹æœ¬èº«
       - è€ƒæŸ¥ç« èŠ‚ç¼–å·æœ¬èº«æ¯«æ— æ„ä¹‰ï¼Œæ˜¯æœ€ä½è´¨é‡çš„å‡ºé¢˜
       - åº”è¯¥è€ƒæŸ¥çŸ¥è¯†ç‚¹çš„å®è´¨å†…å®¹ï¼ˆæ•°å€¼ã€æ–¹æ³•ã€è¦æ±‚ç­‰ï¼‰
     * è¿åæ­¤é¡¹å¿…é¡»æ ‡è®°ä¸º**ä¸¥é‡é—®é¢˜**
   - âš ï¸ ã€ç¦æ­¢ã€‘é¢˜å¹²å’Œé€‰é¡¹ä¸­æ˜¯å¦å‡ºç°äº†å…·ä½“å›¾çº¸å¼•ç”¨ï¼Ÿ
     * âŒ æ£€æŸ¥æ˜¯å¦åŒ…å«"å¦‚å›¾ä¸€æ‰€ç¤º"ã€"å›¾Xæ‰€ç¤º"ã€"æ ¹æ®å›¾çº¸"ç­‰è¡¨è¿°
     * âŒ æ£€æŸ¥æ˜¯å¦æœ‰"è§é™„å›¾"ã€"å‚è€ƒç¤ºæ„å›¾"ã€"ä¸‹å›¾ä¸­"ç­‰éœ€è¦é…å›¾çš„å†…å®¹
     * âŒ æ£€æŸ¥æ˜¯å¦æœ‰"å›¾ä¸­çš„XX"ã€"å›¾ç¤ºç»“æ„"ç­‰ä¾èµ–å›¾çº¸çš„æè¿°
     * åŸå› ï¼šè€ƒé¢˜ä¸é™„å¸¦å›¾çº¸ï¼Œå­¦ç”Ÿæ— æ³•çœ‹åˆ°å›¾çº¸å†…å®¹
     * è¿åæ­¤é¡¹å¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜
   - æ˜¯å¦æœ‰åŒä¸€é¢˜å‹ä¸‹é¢˜ç›®å†…å®¹é‡å¤æˆ–é«˜åº¦ç›¸ä¼¼ï¼Ÿ
   - æ˜¯å¦æœ‰é¢˜ç›®å†…å®¹ä¸çŸ¥è¯†ç‚¹å†…å®¹ä¸ç¬¦ï¼Ÿ

2. **æ ¸å¿ƒçŸ¥è¯†ç‚¹è€ƒå¯Ÿ**ï¼ˆâ­ é‡è¦ï¼‰
   - âš ï¸ é¢˜ç›®æ˜¯å¦èšç„¦åˆ°æ ¸å¿ƒçŸ¥è¯†ç‚¹ä¸Šï¼Ÿ
     * æ£€æŸ¥é¢˜ç›®è€ƒæŸ¥çš„æ˜¯å¦æ˜¯çŸ¥è¯†ç‚¹ä¸­æœ€æ ¸å¿ƒã€æœ€å…³é”®çš„æ¦‚å¿µã€åŸåˆ™ã€æ–¹æ³•ã€å®šä¹‰ç­‰
     * æ£€æŸ¥é¢˜ç›®æ˜¯å¦é¿å…äº†æœºæ¢°åœ°è€ƒæŸ¥å¥å°¾çš„ä¿®é¥°æ€§å†…å®¹
     * ğŸ“Œ åˆ¤æ–­æ ‡å‡†ï¼šå¦‚æœçŸ¥è¯†ç‚¹æ˜¯"XXæ˜¯YY"ï¼Œé¢˜ç›®åº”è€ƒæŸ¥æ ¸å¿ƒçš„"XX"ï¼Œè€Œä¸æ˜¯æè¿°æ€§çš„"YY"
     * ä¾‹å¦‚ï¼š"è´£ä»»æ„è¯†ä¸æ‹…å½“ç²¾ç¥æ˜¯è¡Œä¸ºçš„åŸºçŸ³ä¸é£éª¨"ï¼Œåº”è€ƒæŸ¥"è´£ä»»æ„è¯†ä¸æ‹…å½“ç²¾ç¥"è€Œé"åŸºçŸ³ä¸é£éª¨"
   - é¢˜ç›®æ˜¯å¦å‡†ç¡®è€ƒå¯Ÿäº†æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Ÿ
   - é¢˜ç›®æ˜¯å¦æ¶µç›–äº†çŸ¥è¯†ç‚¹çš„ä¸»è¦æ–¹é¢ï¼Ÿ

3. **çŸ¥è¯†è¦†ç›–åº¦è¯„ä¼°**ï¼ˆâ­ é‡è¦ï¼‰
   è¯·æ£€æŸ¥é¢˜ç›®æ˜¯å¦å…¨é¢è¦†ç›–ä»¥ä¸‹ä¸¤ä¸ªå±‚é¢ï¼š

   å®è§‚å±‚é¢ï¼ˆåŸºç¡€æ ¸å¿ƒçŸ¥è¯†ï¼‰ï¼š
   - æ˜¯å¦è€ƒå¯Ÿäº†åŸºæœ¬å®šä¹‰ã€æ ¸å¿ƒæ¦‚å¿µï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†åˆ†ç±»ä½“ç³»ã€ç±»å‹åˆ’åˆ†ï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†ç»„æˆæ¡†æ¶ã€æ„æˆè¦ç´ ï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†è¡¨è¾¾æ–¹å¼ã€å‘½åè§„åˆ™ï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†æ•´ä½“é€»è¾‘ã€éµå¾ªåŸåˆ™ï¼Ÿ

   å¾®è§‚å±‚é¢ï¼ˆå…·ä½“å†…å®¹ç»†èŠ‚ï¼‰ï¼š
   - æ˜¯å¦è€ƒå¯Ÿäº†å…³é”®å‚æ•°ã€å…·ä½“æ•°å€¼ï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†ç¬¦å·è§„åˆ™ã€æ ‡æ³¨æ–¹æ³•ï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†æ¡ä»¶é™åˆ¶ã€é€‚ç”¨æƒ…å†µï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†ä¾‹å¤–æƒ…å†µã€ç‰¹æ®Šå¤„ç†ï¼Ÿ
   - æ˜¯å¦è€ƒå¯Ÿäº†å…¸å‹ç¤ºä¾‹ã€å®é™…åº”ç”¨ï¼Ÿ

   ğŸ’¡ è¯„ä¼°è¦ç‚¹ï¼š
   - é¢˜ç›®å®è§‚è€ƒæŸ¥ä¸å¾®è§‚è€ƒæŸ¥éƒ½è¦æœ‰ã€‚
   - å¦‚æœåªåé‡æŸä¸€å±‚é¢ï¼Œåº”æŒ‡å‡ºç¼ºå¤±çš„æ–¹é¢

4. **é€‰é¡¹å‡†ç¡®åº¦**ï¼ˆé€‚ç”¨äºå•é€‰é¢˜å’Œå¤šé€‰é¢˜ï¼‰
   - âš ï¸ ã€å…³é”®ã€‘æ­£ç¡®ç­”æ¡ˆæ˜¯å¦åœ¨çŸ¥è¯†ç‚¹åŸæ–‡ä¸­é€å­—é€å¥åœ°å‡ºç°ï¼Ÿ
     * ç­”æ¡ˆå¿…é¡»åœ¨çŸ¥è¯†ç‚¹åŸæ–‡ä¸­ç›´æ¥å‡ºç°ï¼Œé€å­—å¯æŸ¥
     * ä¸å…è®¸æ¨å¯¼ã€å¼•ç”³æˆ–è”æƒ³å¾—å‡ºç­”æ¡ˆ
     * ç­”æ¡ˆä¸­çš„ä¸“ä¸šæœ¯è¯­å¿…é¡»åœ¨çŸ¥è¯†ç‚¹ä¸­æ˜ç¡®å‡ºç°è¿‡
     * ä¸èƒ½ä½¿ç”¨çŸ¥è¯†ç‚¹æœªæåŠçš„æ¦‚å¿µä½œä¸ºç­”æ¡ˆ
   - å¹²æ‰°é€‰é¡¹æ˜¯å¦åˆç†ä¸”å…·æœ‰ä¸€å®šè¿·æƒ‘æ€§ï¼Ÿ
   - é€‰é¡¹æ˜¯å¦æœ‰æ˜æ˜¾é”™è¯¯æˆ–ä¸åˆç†ä¹‹å¤„ï¼Ÿ
   - å¤šé€‰é¢˜çš„æ­£ç¡®ç­”æ¡ˆæ•°é‡æ˜¯å¦åˆç†ï¼ˆè‡³å°‘2ä¸ªï¼‰ï¼Ÿ

5. **æ ¼å¼è§„èŒƒæ€§**
   - é¢˜å¹²æ˜¯å¦ä¸ºé™ˆè¿°å¥ï¼Œä»¥å¥å·ç»“æŸï¼Ÿ
   - å•é€‰/å¤šé€‰é¢˜æ˜¯å¦æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‹¬å·ï¼ˆ   ï¼‰ï¼Ÿ
   - âš ï¸ æ‹¬å·ä½ç½®å¤šæ ·æ€§ï¼šåŒä¸€é‰´å®šç‚¹çš„æ‰€æœ‰å•é€‰é¢˜å’Œå¤šé€‰é¢˜ä¸­ï¼Œæ‹¬å·æ˜¯å¦éƒ½å‡ºç°åœ¨é¢˜å¹²å°¾éƒ¨ï¼Ÿ
     * å¦‚æœæ‰€æœ‰é€‰æ‹©é¢˜çš„æ‹¬å·éƒ½åœ¨å°¾éƒ¨ï¼Œè¿™æ˜¯ä¸¥é‡é—®é¢˜
     * åº”è¯¥æœ‰éƒ¨åˆ†é¢˜ç›®çš„æ‹¬å·åœ¨å¼€å¤´æˆ–ä¸­é—´ä½ç½®
   - å•é€‰é¢˜æ˜¯å¦æœ‰4ä¸ªé€‰é¡¹ï¼Ÿå¤šé€‰é¢˜æ˜¯å¦æœ‰5ä¸ªé€‰é¡¹ï¼Ÿ
   - âš ï¸ å•é€‰é¢˜çš„4ä¸ªé€‰é¡¹å†…å®¹æ˜¯å¦å„ä¸ç›¸åŒï¼Ÿå¤šé€‰é¢˜çš„5ä¸ªé€‰é¡¹å†…å®¹æ˜¯å¦å„ä¸ç›¸åŒï¼Ÿ
   - ç­”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå•é€‰ï¼šAï¼Œå¤šé€‰ï¼šABCï¼Œåˆ¤æ–­ï¼šæ­£ç¡®/é”™è¯¯ï¼‰ï¼Ÿ
   - âš ï¸ é¢˜å¹²ä¸­æ˜¯å¦å‡ºç°äº†"é‰´å®šç‚¹"ã€"çŸ¥è¯†ç‚¹"ç­‰æŒ‡å‘ä¸æ˜çš„è¯æ±‡ï¼Ÿ
     * å¦‚å‡ºç°"çŸ¥è¯†ç‚¹ä¸­"ã€"è¯¥çŸ¥è¯†ç‚¹"ã€"é‰´å®šç‚¹æè¿°"ç­‰ï¼Œå¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜
   - âš ï¸ é¢˜å¹²ä¸­æ˜¯å¦å‡ºç°äº†"ï¼ˆ   ï¼‰ç­‰"è¿™ç§æ¨¡ç³Šè¡¨è¿°ï¼Ÿ
     * è¿™ç§è¡¨è¿°æš—ç¤ºè¿˜æœ‰å…¶ä»–æœªåˆ—ä¸¾é€‰é¡¹ï¼Œä¼šé€ æˆç­”æ¡ˆä¸å”¯ä¸€æˆ–æœ‰äº‰è®®
     * å¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜
   - âš ï¸ é¢˜å¹²å’Œé€‰é¡¹ä¸­æ˜¯å¦å‡ºç°äº†å›¾è¡¨å¼•ç”¨ï¼ˆå¦‚"å›¾X.X"ã€"è¡¨X.X"ã€"å¦‚å›¾æ‰€ç¤º"ç­‰ï¼‰ï¼Ÿ
   - âš ï¸ æ˜¯å¦å‡ºç°äº†"ä¾‹å¦‚"é¢˜ï¼Ÿæ£€æŸ¥é¢˜å¹²ä¸­æ˜¯å¦åŒ…å«"ä¾‹å¦‚ï¼ˆ   ï¼‰"æˆ–"å¦‚ï¼ˆ   ï¼‰"æ ¼å¼ã€‚
   - âš ï¸ é¢˜å¹²å’Œé€‰é¡¹ä¸­æ˜¯å¦å‡ºç°äº†ç« èŠ‚ç¼–å·ï¼Ÿ
     * æ£€æŸ¥æ˜¯å¦æœ‰"5.2.4"ã€"ç¬¬3ç« "ã€"3.1.2"ç­‰ç« èŠ‚ç¼–å·
     * å¦‚æœ‰ï¼Œå¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜
   - âš ï¸ é¢˜å¹²å’Œé€‰é¡¹ä¸­æ˜¯å¦å‡ºç°äº†å…·ä½“å›¾çº¸å¼•ç”¨ï¼Ÿ
     * æ£€æŸ¥æ˜¯å¦æœ‰"å¦‚å›¾ä¸€æ‰€ç¤º"ã€"å›¾Xæ‰€ç¤º"ã€"è§é™„å›¾"ã€"å›¾ä¸­çš„XX"ç­‰è¡¨è¿°
     * å¦‚æœ‰ï¼Œå¿…é¡»æ ‡è®°ä¸ºä¸¥é‡é—®é¢˜

6. **è¯­è¨€è¡¨è¾¾**
   - é¢˜å¹²å’Œé€‰é¡¹çš„è¡¨è¾¾æ˜¯å¦æ¸…æ™°å‡†ç¡®ï¼Ÿ
   - æ˜¯å¦å­˜åœ¨æ­§ä¹‰æˆ–è¯­ç—…ï¼Ÿ

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºè¯„ä¼°ç»“æœï¼š
{{
    "æ€»ä½“è¯„ä»·": "ä¼˜ç§€/è‰¯å¥½/éœ€è¦æ”¹è¿›",
    "æ˜¯å¦é€šè¿‡": true/false,
    "é—®é¢˜åˆ—è¡¨": [
        {{
            "é¢˜ç›®åºå·": 1,
            "é—®é¢˜ç±»å‹": "é‡å¤æ€§/æ ¸å¿ƒçŸ¥è¯†ç‚¹/çŸ¥è¯†è¦†ç›–åº¦/é€‰é¡¹å‡†ç¡®åº¦/æ ¼å¼è§„èŒƒ/è¯­è¨€è¡¨è¾¾",
            "é—®é¢˜æè¿°": "å…·ä½“é—®é¢˜è¯´æ˜",
            "ä¸¥é‡ç¨‹åº¦": "ä¸¥é‡/ä¸€èˆ¬/è½»å¾®"
        }}
    ],
    "ä¿®æ”¹å»ºè®®": [
        {{
            "é¢˜ç›®åºå·": 1,
            "å»ºè®®å†…å®¹": "å…·ä½“çš„ä¿®æ”¹å»ºè®®"
        }}
    ]
}}

æ³¨æ„ï¼š
1. å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜åˆ—è¡¨ä¸ºç©ºæ•°ç»„ï¼Œis_passedä¸ºtrue
2. ä¸¥é‡é—®é¢˜å¿…é¡»ä¿®æ”¹ï¼Œä¸€èˆ¬é—®é¢˜å»ºè®®ä¿®æ”¹ï¼Œè½»å¾®é—®é¢˜å¯ä»¥å¿½ç•¥
3. æœ‰ä¸¥é‡é—®é¢˜æˆ–å¤šä¸ªä¸€èˆ¬é—®é¢˜æ—¶ï¼Œis_passedåº”ä¸ºfalse
"""

        try:
            logging.info(f"  æ­£åœ¨è°ƒç”¨AIè¯„ä¼°é¢˜ç›®...")
            sys.stdout.flush()  # ç«‹å³åˆ·æ–°è¾“å‡º

            completion = self.client.chat.completions.create(
                model="qwen3-max",
                messages=[
                    {
                        "role": "system",
                        "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•è´¨é‡è¯„ä¼°ä¸“å®¶ã€‚è¯·å®¢è§‚ã€ä¸¥æ ¼åœ°è¯„ä¼°é¢˜ç›®è´¨é‡ï¼Œä»¥JSONæ ¼å¼è¿”å›è¯„ä¼°ç»“æœã€‚"
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                response_format={"type": "json_object"}
            )

            logging.info(f"  AIè¯„ä¼°å®Œæˆï¼Œæ­£åœ¨è§£æç»“æœ...")
            sys.stdout.flush()  # ç«‹å³åˆ·æ–°è¾“å‡º

            json_string = completion.choices[0].message.content
            evaluation = json.loads(json_string)

            return evaluation

        except Exception as e:
            logging.error(f"è¯„ä¼°é¢˜ç›®æ—¶å‡ºé”™: {e}")
            return {"æ˜¯å¦é€šè¿‡": True, "é—®é¢˜åˆ—è¡¨": [], "ä¿®æ”¹å»ºè®®": []}

    def fix_questions(self, knowledge_point: Dict[str, str],
                     questions: List[Dict],
                     evaluation: Dict) -> Optional[List[Dict]]:
        """
        æ ¹æ®è¯„ä¼°ç»“æœä¿®æ­£é¢˜ç›®

        Args:
            knowledge_point: é‰´å®šç‚¹ä¿¡æ¯
            questions: åŸå§‹é¢˜ç›®åˆ—è¡¨
            evaluation: è¯„ä¼°ç»“æœ

        Returns:
            ä¿®æ­£åçš„é¢˜ç›®åˆ—è¡¨
        """
        questions_text = json.dumps(questions, ensure_ascii=False, indent=2)
        problems_text = json.dumps(evaluation.get("é—®é¢˜åˆ—è¡¨", []), ensure_ascii=False, indent=2)
        suggestions_text = json.dumps(evaluation.get("ä¿®æ”¹å»ºè®®", []), ensure_ascii=False, indent=2)

        prompt = f"""
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•å‘½é¢˜ä¸“å®¶ã€‚è¯·æ ¹æ®è¯„ä¼°åé¦ˆï¼Œä¿®æ­£ä»¥ä¸‹é¢˜ç›®ä¸­å­˜åœ¨çš„é—®é¢˜ã€‚

ã€çŸ¥è¯†ç‚¹ä¿¡æ¯ã€‘
é‰´å®šç‚¹ç¼–å·: {knowledge_point['ç¼–å·']}
é‰´å®šç‚¹åç§°: {knowledge_point['åç§°']}
çŸ¥è¯†ç‚¹å†…å®¹: {knowledge_point['å†…å®¹']}

ã€åŸå§‹é¢˜ç›®ã€‘
{questions_text}

ã€å‘ç°çš„é—®é¢˜ã€‘
{problems_text}

ã€ä¿®æ”¹å»ºè®®ã€‘
{suggestions_text}

ã€ä¿®æ­£è¦æ±‚ã€‘
1. é’ˆå¯¹æ¯ä¸ªé—®é¢˜è¿›è¡Œä¿®æ­£
2. ä¿æŒé¢˜ç›®æ€»æ•°ä¸å˜
3. ç¡®ä¿ä¿®æ­£åçš„é¢˜ç›®ç¬¦åˆæ‰€æœ‰æ ¼å¼è¦æ±‚
4. é¢˜ç›®å†…å®¹å¿…é¡»åŸºäºçŸ¥è¯†ç‚¹å†…å®¹
5. é¿å…é¢˜ç›®é‡å¤

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºä¿®æ­£åçš„å®Œæ•´é¢˜ç›®åˆ—è¡¨ï¼š
{{
    "é¢˜ç›®åˆ—è¡¨": [
        {{
            "é¢˜ç›®ç±»å‹": "å•é€‰/åˆ¤æ–­/å¤šé€‰",
            "é¢˜å¹²": "...",
            "é€‰é¡¹A": "...",
            "ç­”æ¡ˆ": "..."
        }}
    ]
}}
"""

        try:
            logging.info(f"  æ­£åœ¨è°ƒç”¨AIä¿®æ­£é¢˜ç›®...")
            sys.stdout.flush()  # ç«‹å³åˆ·æ–°è¾“å‡º

            completion = self.client.chat.completions.create(
                model="qwen3-max",
                messages=[
                    {
                        "role": "system",
                        "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•å‘½é¢˜ä¸“å®¶ã€‚è¯·æ ¹æ®åé¦ˆè®¤çœŸä¿®æ­£é¢˜ç›®ï¼Œç¡®ä¿é¢˜ç›®è´¨é‡ï¼Œä»¥JSONæ ¼å¼è¿”å›ã€‚"
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                response_format={"type": "json_object"}
            )

            logging.info(f"  AIä¿®æ­£å®Œæˆï¼Œæ­£åœ¨è§£æç»“æœ...")
            sys.stdout.flush()  # ç«‹å³åˆ·æ–°è¾“å‡º

            json_string = completion.choices[0].message.content
            response_data = json.loads(json_string)

            # æå–é¢˜ç›®åˆ—è¡¨
            fixed_questions = response_data.get("é¢˜ç›®åˆ—è¡¨", [])

            # ä¸ºæ¯ä¸ªé¢˜ç›®æ·»åŠ é‰´å®šç‚¹ç¼–å·
            for q in fixed_questions:
                q["é‰´å®šç‚¹ç¼–å·"] = knowledge_point["ç¼–å·"]

            return fixed_questions

        except Exception as e:
            logging.error(f"ä¿®æ­£é¢˜ç›®æ—¶å‡ºé”™: {e}")
            return None

    def generate_questions_for_point(self, knowledge_point: Dict[str, str],
                                    level: str) -> List[Dict]:
        """
        ä¸ºå•ä¸ªé‰´å®šç‚¹ç”Ÿæˆæ‰€æœ‰é¢˜ç›®ï¼ˆåŒ…å«è´¨é‡è¯„ä¼°å’Œä¿®æ­£æœºåˆ¶ï¼‰
        è¦æ±‚ï¼šå¿…é¡»è¾¾åˆ°"ä¼˜ç§€"è¯„çº§æ‰èƒ½ä¿å­˜

        Args:
            knowledge_point: é‰´å®šç‚¹ä¿¡æ¯
            level: ç­‰çº§ï¼ˆä»…ç”¨äºç¡®å®šé¢˜ç›®æ•°é‡ï¼šä¸€çº§/äºŒçº§/ä¸‰çº§=7é¢˜ï¼Œå››çº§/äº”çº§=6é¢˜ï¼‰

        Returns:
            é¢˜ç›®åˆ—è¡¨
        """
        logging.info(f"\næ­£åœ¨ä¸ºé‰´å®šç‚¹ {knowledge_point['ç¼–å·']} ç”Ÿæˆé¢˜ç›®...")
        sys.stdout.flush()

        max_iterations = 5  # å¢åŠ æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæœºä¼šè¾¾åˆ°ä¼˜ç§€
        iteration = 0

        while iteration < max_iterations:
            iteration += 1
            logging.info(f"\n  ç¬¬ {iteration} è½®ç”Ÿæˆ...")
            sys.stdout.flush()

            # ç”Ÿæˆé¢˜ç›®
            questions = self.generate_all_questions_at_once(knowledge_point, level)

            if not questions:
                logging.warning(f"  âŒ ç”Ÿæˆå¤±è´¥")
                sys.stdout.flush()
                continue

            logging.info(f"  âœ“ æˆåŠŸç”Ÿæˆ {len(questions)} é“é¢˜ç›®")
            sys.stdout.flush()

            # è¯„ä¼°é¢˜ç›®è´¨é‡
            logging.info(f"  æ­£åœ¨è¯„ä¼°é¢˜ç›®è´¨é‡...")
            sys.stdout.flush()
            evaluation = self.evaluate_questions(knowledge_point, questions)

            is_passed = evaluation.get("æ˜¯å¦é€šè¿‡", False)
            problems = evaluation.get("é—®é¢˜åˆ—è¡¨", [])
            overall = evaluation.get("æ€»ä½“è¯„ä»·", "æœªçŸ¥")

            logging.info(f"  è¯„ä¼°ç»“æœ: {overall}")
            sys.stdout.flush()

            # åªæ¥å—"ä¼˜ç§€"è¯„çº§
            if overall == "ä¼˜ç§€" and is_passed:
                logging.info(f"  âœ“ é¢˜ç›®è´¨é‡ä¼˜ç§€ï¼Œé€šè¿‡è¯„ä¼°ï¼")
                sys.stdout.flush()
                return questions
            elif overall == "è‰¯å¥½":
                logging.warning(f"  âš  é¢˜ç›®è´¨é‡ä¸ºè‰¯å¥½ï¼Œéœ€è¦ä¼˜åŒ–è‡³ä¼˜ç§€")
                logging.warning(f"  âš  å‘ç° {len(problems)} ä¸ªé—®é¢˜ï¼Œéœ€è¦æ”¹è¿›")
                sys.stdout.flush()
            else:
                logging.warning(f"  âš  é¢˜ç›®è´¨é‡éœ€è¦æ”¹è¿›ï¼Œå‘ç° {len(problems)} ä¸ªé—®é¢˜")
                sys.stdout.flush()

            # æ˜¾ç¤ºé—®é¢˜
            for i, problem in enumerate(problems[:3], 1):  # åªæ˜¾ç¤ºå‰3ä¸ªé—®é¢˜
                logging.info(f"    - é¢˜ç›®{problem.get('é¢˜ç›®åºå·', '?')}: {problem.get('é—®é¢˜æè¿°', '')[:50]}...")
            sys.stdout.flush()

            if iteration < max_iterations:
                logging.info(f"  æ­£åœ¨ä¼˜åŒ–é¢˜ç›®...")
                sys.stdout.flush()
                fixed_questions = self.fix_questions(knowledge_point, questions, evaluation)

                if fixed_questions:
                    questions = fixed_questions
                    logging.info(f"  âœ“ é¢˜ç›®å·²ä¼˜åŒ–ï¼Œè¿›å…¥ä¸‹ä¸€è½®è¯„ä¼°")
                    sys.stdout.flush()
                else:
                    logging.warning(f"  âŒ ä¼˜åŒ–å¤±è´¥ï¼Œé‡æ–°ç”Ÿæˆ")
                    sys.stdout.flush()
                    continue
            else:
                logging.warning(f"  âš  å·²è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆ{max_iterations}è½®ï¼‰")
                if overall == "è‰¯å¥½":
                    logging.warning(f"  âš  å½“å‰è¯„çº§ä¸ºè‰¯å¥½ï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥")
                sys.stdout.flush()
                return questions

        logging.error(f"  âŒ æœªèƒ½ç”Ÿæˆä¼˜ç§€çº§åˆ«çš„é¢˜ç›®")
        sys.stdout.flush()
        return []

    def save_questions_to_xls(self, questions: List[Dict],
                              output_filepath: str):
        """
        å°†é¢˜ç›®ä¿å­˜åˆ°XLSæ–‡ä»¶

        Args:
            questions: é¢˜ç›®åˆ—è¡¨
            output_filepath: è¾“å‡ºæ–‡ä»¶è·¯å¾„
        """
        # åˆ›å»ºå·¥ä½œç°¿
        wb = xlwt.Workbook(encoding='utf-8')
        ws = wb.add_sheet('é¢˜ç›®')

        # è®¾ç½®å®‹ä½“æ ·å¼
        style = xlwt.XFStyle()
        font = xlwt.Font()
        font.name = 'å®‹ä½“'
        font.height = 220  # 11å·å­—ä½“ (20 * 11)
        style.font = font

        # å†™å…¥è¡¨å¤´
        headers = ["é‰´å®šç‚¹ä»£ç ", "é¢˜ç›®ç±»å‹ä»£ç ", "è¯•é¢˜(é¢˜å¹²)",
                  "é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C", "é€‰é¡¹D", "é€‰é¡¹E",
                  "ç­”æ¡ˆ", "éš¾åº¦ä»£ç ", "ä¸€è‡´æ€§ä»£ç "]
        for col, header in enumerate(headers):
            ws.write(0, col, header, style)

        # å†™å…¥é¢˜ç›®
        for row_idx, q in enumerate(questions, start=1):
            # ç¡®å®šé¢˜ç›®ç±»å‹ä»£ç 
            type_code_map = {"å•é€‰": "B", "åˆ¤æ–­": "C", "å¤šé€‰": "D"}
            type_code = type_code_map.get(q.get("é¢˜ç›®ç±»å‹", ""), "B")

            # å†™å…¥æ•°æ®
            data = [
                q.get("é‰´å®šç‚¹ç¼–å·", ""),
                type_code,
                q.get("é¢˜å¹²", ""),
                q.get("é€‰é¡¹A", ""),
                q.get("é€‰é¡¹B", ""),
                q.get("é€‰é¡¹C", ""),
                q.get("é€‰é¡¹D", ""),
                q.get("é€‰é¡¹E", ""),
                q.get("ç­”æ¡ˆ", ""),
                3,  # éš¾åº¦ä»£ç 
                5   # ä¸€è‡´æ€§ä»£ç 
            ]
            for col_idx, value in enumerate(data):
                ws.write(row_idx, col_idx, value, style)

        wb.save(output_filepath)
        logging.info(f"  âœ“ XLSæ–‡ä»¶å·²ä¿å­˜åˆ°: {output_filepath}")

    def save_questions_to_docx(self, questions: List[Dict],
                               output_filepath: str):
        """
        å°†é¢˜ç›®ä¿å­˜åˆ°Wordæ–‡æ¡£

        Args:
            questions: é¢˜ç›®åˆ—è¡¨
            output_filepath: è¾“å‡ºæ–‡ä»¶è·¯å¾„
        """
        doc = Document()

        # è®¾ç½®é»˜è®¤å­—ä½“ä¸ºå®‹ä½“
        style = doc.styles['Normal']
        style.font.name = 'å®‹ä½“'
        style.font.size = Pt(11)

        # ç¡®å®šé¢˜ç›®ç±»å‹ä»£ç æ˜ å°„
        type_code_map = {"å•é€‰": "B", "åˆ¤æ–­": "C", "å¤šé€‰": "D"}

        # é€é¢˜å†™å…¥
        for idx, q in enumerate(questions):
            # è·å–é¢˜ç›®ä¿¡æ¯
            code = q.get("é‰´å®šç‚¹ç¼–å·", "")
            type_code = type_code_map.get(q.get("é¢˜ç›®ç±»å‹", ""), "B")
            question_text = q.get("é¢˜å¹²", "")
            answer = q.get("ç­”æ¡ˆ", "")

            # ç¬¬1è¡Œ: é‰´å®šç‚¹ç¼–å·  é¢˜å‹  éš¾åº¦ä»£ç   ä¸€è‡´æ€§ä»£ç 
            p1 = doc.add_paragraph(f"{code}  {type_code}  3  5")
            p1.style.font.name = 'å®‹ä½“'
            p1.style.font.size = Pt(11)

            # ç¬¬2è¡Œ: {A} é¢˜å¹²
            p2 = doc.add_paragraph(f"{{A}}{question_text}")
            p2.style.font.name = 'å®‹ä½“'
            p2.style.font.size = Pt(11)

            # é€‰é¡¹è¡Œ (å•é€‰å’Œå¤šé€‰é¢˜)
            if type_code in ["B", "D"]:  # å•é€‰æˆ–å¤šé€‰
                for option_key in ["A", "B", "C", "D", "E"]:
                    option_value = q.get(f"é€‰é¡¹{option_key}", "")
                    if option_value:  # åªå†™å…¥éç©ºé€‰é¡¹
                        p_opt = doc.add_paragraph(f"ï¼ˆ{option_key}ï¼‰{option_value}")
                        p_opt.style.font.name = 'å®‹ä½“'
                        p_opt.style.font.size = Pt(11)

            # ç­”æ¡ˆè¡Œ: {B} ç­”æ¡ˆ
            p_ans = doc.add_paragraph(f"{{B}}{answer}")
            p_ans.style.font.name = 'å®‹ä½“'
            p_ans.style.font.size = Pt(11)

            # é¢˜ç›®é—´ç©ºä¸€è¡Œ (é™¤äº†æœ€åä¸€é¢˜)
            if idx < len(questions) - 1:
                doc.add_paragraph()

        doc.save(output_filepath)
        logging.info(f"  âœ“ Wordæ–‡æ¡£å·²ä¿å­˜åˆ°: {output_filepath}")

    def get_existing_question_codes(self, output_dir: str) -> set:
        """
        è·å–å·²å­˜åœ¨çš„é¢˜ç›®æ–‡ä»¶å¯¹åº”çš„é‰´å®šç‚¹ç¼–å·
        
        Args:
            output_dir: è¾“å‡ºç›®å½•è·¯å¾„ï¼ˆåŒ…å«xlsxæ–‡ä»¶åçš„å­ç›®å½•ï¼‰
            
        Returns:
            å·²å­˜åœ¨é¢˜ç›®çš„é‰´å®šç‚¹ç¼–å·é›†åˆ
        """
        existing_codes = set()
        
        if not os.path.exists(output_dir):
            return existing_codes
            
        for filename in os.listdir(output_dir):
            if filename.startswith("è€ƒé¢˜") and filename.endswith(".xls"):
                # ä»æ–‡ä»¶åä¸­æå–é‰´å®šç‚¹ç¼–å·ï¼Œæ ¼å¼ï¼šè€ƒé¢˜A-B-A-001.xls
                code = filename[2:-4]  # å»æ‰"è€ƒé¢˜"å‰ç¼€å’Œ".xls"åç¼€
                existing_codes.add(code)
                
        return existing_codes

    def resolve_input_path(self, input_path: str) -> str:
        """
        è§£æè¾“å…¥æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœåªæä¾›æ–‡ä»¶åï¼Œåˆ™åœ¨resourcesç›®å½•ä¸­æŸ¥æ‰¾

        Args:
            input_path: è¾“å…¥è·¯å¾„æˆ–æ–‡ä»¶å

        Returns:
            å®Œæ•´çš„æ–‡ä»¶è·¯å¾„
        """
        # å¦‚æœæ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ï¼ˆåŒ…å«è·¯å¾„åˆ†éš”ç¬¦ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
        if os.path.sep in input_path or os.path.isabs(input_path):
            return input_path
        
        # å¦‚æœåªæ˜¯æ–‡ä»¶åï¼Œåœ¨resourcesç›®å½•ä¸­æŸ¥æ‰¾
        resources_dir = os.path.join(os.path.dirname(__file__), "resources")
        resources_path = os.path.join(resources_dir, input_path)
        
        if os.path.exists(resources_path):
            return resources_path
        
        # å¦‚æœresourcesç›®å½•ä¸­æ²¡æœ‰ï¼Œè¿”å›åŸè·¯å¾„
        return input_path

    def process_file(self, input_filepath: str, output_dir: str = None):
        """
        å¤„ç†å•ä¸ªè¾“å…¥æ–‡ä»¶,ç”Ÿæˆè€ƒé¢˜

        Args:
            input_filepath: è¾“å…¥xlsxæ–‡ä»¶è·¯å¾„
            output_dir: è¾“å‡ºç›®å½•,å¦‚æœä¸ºNoneåˆ™é»˜è®¤ä½¿ç”¨questionsç›®å½•
        """
        # è§£æè¾“å…¥æ–‡ä»¶è·¯å¾„
        resolved_input_path = self.resolve_input_path(input_filepath)
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(resolved_input_path):
            logging.error(f"âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: {resolved_input_path}")
            sys.stdout.flush()
            return
        
        # æå–æ–‡ä»¶å
        filename = os.path.basename(resolved_input_path)
        logging.info(f"\n{'='*60}")
        logging.info(f"å¤„ç†æ–‡ä»¶: {filename}")
        logging.info(f"æ–‡ä»¶è·¯å¾„: {resolved_input_path}")
        logging.info(f"{'='*60}")
        sys.stdout.flush()

        # æå–ç­‰çº§ä¿¡æ¯
        level = self.extract_level_from_filename(filename)
        if not level:
            logging.error(f"âŒ é”™è¯¯: æ— æ³•ä»æ–‡ä»¶å '{filename}' ä¸­æå–ç­‰çº§ä¿¡æ¯")
            logging.error(f"   æ–‡ä»¶åå¿…é¡»åŒ…å«: ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ã€å››çº§æˆ–äº”çº§")
            sys.stdout.flush()
            return

        logging.info(f"âœ“ æ£€æµ‹åˆ°ç­‰çº§: {level}")
        logging.info(f"âœ“ å‡ºé¢˜è¦æ±‚: {self.LEVEL_REQUIREMENTS[level]}")
        sys.stdout.flush()

        # è¯»å–é‰´å®šç‚¹
        logging.info(f"æ­£åœ¨è¯»å–é‰´å®šç‚¹...")
        sys.stdout.flush()
        knowledge_points = self.read_knowledge_points(resolved_input_path)
        logging.info(f"âœ“ è¯»å–åˆ° {len(knowledge_points)} ä¸ªé‰´å®šç‚¹")
        sys.stdout.flush()

        # ç¡®å®šè¾“å‡ºç›®å½• - åœ¨questionsä¸‹åˆ›å»ºä»¥xlsxæ–‡ä»¶åå‘½åçš„å­ç›®å½•
        if output_dir is None:
            # é»˜è®¤ä¿å­˜åˆ°questionsç›®å½•
            base_output_dir = os.path.join(os.path.dirname(__file__), "questions")
            # ä»æ–‡ä»¶åä¸­æå–åŸºç¡€åç§°ï¼ˆå»æ‰.xlsxåç¼€ï¼‰
            xlsx_basename = os.path.splitext(filename)[0]
            # åˆ›å»ºå­ç›®å½•ï¼šquestions/äº”çº§5001-5010/
            output_dir = os.path.join(base_output_dir, xlsx_basename)

        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        if not os.path.exists(output_dir):
            os.makedirs(output_dir)
            logging.info(f"âœ“ åˆ›å»ºè¾“å‡ºç›®å½•: {output_dir}")

        logging.info(f"âœ“ è¾“å‡ºç›®å½•: {output_dir}")
        sys.stdout.flush()

        # è·å–å·²å­˜åœ¨çš„é¢˜ç›®æ–‡ä»¶ï¼ˆä»å½“å‰xlsxå¯¹åº”çš„å­ç›®å½•ä¸­ï¼‰
        existing_codes = self.get_existing_question_codes(output_dir)
        if existing_codes:
            logging.info(f"âœ“ å‘ç°å·²å­˜åœ¨ {len(existing_codes)} ä¸ªé¢˜ç›®æ–‡ä»¶")
            logging.info(f"  å·²å­˜åœ¨çš„é‰´å®šç‚¹: {', '.join(sorted(existing_codes))}")
        else:
            logging.info(f"âœ“ æœªå‘ç°å·²å­˜åœ¨çš„é¢˜ç›®æ–‡ä»¶ï¼Œå°†ç”Ÿæˆæ‰€æœ‰é¢˜ç›®")
        sys.stdout.flush()

        # ç­›é€‰éœ€è¦ç”Ÿæˆé¢˜ç›®çš„é‰´å®šç‚¹ï¼ˆå¢é‡ç”Ÿæˆï¼‰
        new_knowledge_points = [kp for kp in knowledge_points if kp['ç¼–å·'] not in existing_codes]
        
        if not new_knowledge_points:
            logging.info(f"âœ“ æ‰€æœ‰é‰´å®šç‚¹çš„é¢˜ç›®éƒ½å·²å­˜åœ¨ï¼Œæ— éœ€ç”Ÿæˆæ–°é¢˜ç›®")
            sys.stdout.flush()
            return
        
        logging.info(f"âœ“ éœ€è¦ç”Ÿæˆé¢˜ç›®çš„é‰´å®šç‚¹: {len(new_knowledge_points)} ä¸ª")
        sys.stdout.flush()

        # ä¸ºéœ€è¦ç”Ÿæˆçš„é‰´å®šç‚¹ç”Ÿæˆé¢˜ç›®å¹¶ä¿å­˜
        for i, kp in enumerate(new_knowledge_points, 1):
            logging.info(f"\n{'â”€'*60}")
            logging.info(f"é‰´å®šç‚¹: {kp['ç¼–å·']} - {kp['åç§°']}")
            sys.stdout.flush()

            # ç”Ÿæˆé¢˜ç›®
            questions = self.generate_questions_for_point(kp, level)

            if not questions:
                logging.warning(f"  âš  è­¦å‘Š: è¯¥é‰´å®šç‚¹æœªç”Ÿæˆä»»ä½•é¢˜ç›®")
                sys.stdout.flush()
                continue

            logging.info(f"  âœ“ æˆåŠŸç”Ÿæˆ {len(questions)} é“é¢˜ç›®")
            sys.stdout.flush()

            # ä¿å­˜ä¸ºXLSæ ¼å¼ï¼ˆä¿æŒåŸæœ‰æ ¼å¼ï¼‰
            xls_filename = f"è€ƒé¢˜{kp['ç¼–å·']}.xls"
            xls_filepath = os.path.join(output_dir, xls_filename)
            self.save_questions_to_xls(questions, xls_filepath)

            # ä¿å­˜ä¸ºWordæ–‡æ¡£
            docx_filename = f"{kp['ç¼–å·']}.docx"
            docx_filepath = os.path.join(output_dir, docx_filename)
            self.save_questions_to_docx(questions, docx_filepath)


def process_all_resources():
    """å¤„ç†resourcesç›®å½•ä¸­çš„æ‰€æœ‰xlsxæ–‡ä»¶"""
    # åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
    log_filepath = setup_logging()
    logging.info("="*60)
    logging.info("è€ƒé¢˜ç”Ÿæˆç³»ç»Ÿå¯åŠ¨ - æ‰¹é‡å¢é‡å¤„ç†æ¨¡å¼")
    logging.info(f"æ—¥å¿—æ–‡ä»¶: {log_filepath}")
    logging.info("="*60)
    sys.stdout.flush()

    # è·å–resourcesç›®å½•è·¯å¾„
    script_dir = os.path.dirname(__file__)
    resources_dir = os.path.join(script_dir, "resources")
    
    if not os.path.exists(resources_dir):
        logging.error(f"âŒ é”™è¯¯: resourcesç›®å½•ä¸å­˜åœ¨: {resources_dir}")
        sys.stdout.flush()
        return

    # è·å–æ‰€æœ‰xlsxæ–‡ä»¶
    xlsx_files = [f for f in os.listdir(resources_dir) if f.endswith('.xlsx')]
    
    if not xlsx_files:
        logging.info("âœ“ resourcesç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°xlsxæ–‡ä»¶")
        sys.stdout.flush()
        return

    logging.info(f"âœ“ å‘ç° {len(xlsx_files)} ä¸ªæ•™ææ–‡ä»¶:")
    for f in sorted(xlsx_files):
        logging.info(f"  - {f}")
    sys.stdout.flush()

    # åˆ›å»ºç”Ÿæˆå™¨
    try:
        generator = QuestionGenerator()
    except ValueError as e:
        logging.error(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}")
        logging.error("è¯·ç¡®ä¿åœ¨.envæ–‡ä»¶ä¸­è®¾ç½®äº†DASHSCOPE_API_KEY")
        sys.stdout.flush()
        return

    # å¤„ç†æ¯ä¸ªæ–‡ä»¶
    total_processed = 0
    for xlsx_file in sorted(xlsx_files):
        try:
            generator.process_file(xlsx_file)
            total_processed += 1
        except Exception as e:
            logging.error(f"âŒ å¤„ç†æ–‡ä»¶ {xlsx_file} æ—¶å‡ºé”™: {e}")
            sys.stdout.flush()
            continue

    logging.info(f"\n{'='*60}")
    logging.info(f"æ‰¹é‡å¤„ç†å®Œæˆ! æˆåŠŸå¤„ç† {total_processed}/{len(xlsx_files)} ä¸ªæ–‡ä»¶")
    logging.info(f"æ—¥å¿—å·²ä¿å­˜åˆ°: {log_filepath}")
    logging.info(f"{'='*60}\n")

def main():
    """ä¸»å‡½æ•°"""
    import sys

    # æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°
    if len(sys.argv) < 2:
        # æ²¡æœ‰å‚æ•°æ—¶ï¼Œæ‰¹é‡å¤„ç†resourcesç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        process_all_resources()
        return

    # æœ‰å‚æ•°æ—¶ï¼Œå¤„ç†æŒ‡å®šæ–‡ä»¶
    # åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
    log_filepath = setup_logging()
    logging.info("="*60)
    logging.info("è€ƒé¢˜ç”Ÿæˆç³»ç»Ÿå¯åŠ¨ - å•æ–‡ä»¶å¤„ç†æ¨¡å¼")
    logging.info(f"æ—¥å¿—æ–‡ä»¶: {log_filepath}")
    logging.info("="*60)
    sys.stdout.flush()

    input_file = sys.argv[1]
    output_dir = sys.argv[2] if len(sys.argv) > 2 else None

    # åˆ›å»ºç”Ÿæˆå™¨å¹¶å¤„ç†æ–‡ä»¶
    try:
        generator = QuestionGenerator()
        generator.process_file(input_file, output_dir)
    except ValueError as e:
        logging.error(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}")
        logging.error("è¯·ç¡®ä¿åœ¨.envæ–‡ä»¶ä¸­è®¾ç½®äº†DASHSCOPE_API_KEY")
        sys.stdout.flush()
        return

    logging.info(f"\n{'='*60}")
    logging.info("å¤„ç†å®Œæˆ!")
    logging.info(f"æ—¥å¿—å·²ä¿å­˜åˆ°: {log_filepath}")
    logging.info(f"{'='*60}\n")


if __name__ == "__main__":
    main()
